<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Verification Dashboard v4 - Enhanced Alerts & Flowchart</title>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #ff0054;
            --info: #4895ef;
            --manager: #06d6a0;
            --dark: #212529;
            --light: #f8f9fa;
            --border: #dee2e6;
            --text-gray: #6c757d;
            --sidebar-width: 260px;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Dashboard Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--dark) 0%, #343a40 100%);
            color: white;
            padding: 25px 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(45deg, #4cc9f0, #4361ee);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: rgba(255,255,255,0.8);
            font-weight: 500;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }

        .agent-profile {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .agent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .manager-badge {
            background: var(--manager);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            min-width: 0;
        }

        /* Header */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left h1 {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--dark), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 5px;
        }

        .session-info {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .session-badge {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: white;
        }

        .stat-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-gray);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 5px;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
        }

        .status-pending { background: rgba(251, 191, 36, 0.15); color: #d97706; }
        .status-delivered { background: rgba(76, 201, 240, 0.15); color: #0891b2; }
        .status-delayed { background: rgba(247, 37, 133, 0.15); color: #be185d; }
        .status-cancelled { background: rgba(108, 117, 125, 0.15); color: var(--text-gray); }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            color: white;
        }

        .btn-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-edit { background: var(--info); }
        .btn-cancel { background: var(--danger); }
        .btn-save { background: var(--success); }
        .btn-refresh { background: var(--warning); }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #38b000);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--danger), #d00000);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-manager {
            background: linear-gradient(45deg, var(--manager), #06a884);
            color: white;
        }

        /* Table */
        .table-wrapper {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .table-header {
            padding: 25px;
            background: linear-gradient(90deg, #f8f9fa, #e9ecef);
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 18px 20px;
            text-align: left;
            font-weight: 700;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
            user-select: none;
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* CRITICAL ALERT STYLES */
        .critical-alert {
            animation: pulse 1.5s infinite;
            border: 2px solid var(--danger);
            background: linear-gradient(45deg, rgba(255, 0, 84, 0.1), rgba(255, 0, 84, 0.05));
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 84, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 84, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 84, 0); }
        }

        .warning-alert {
            border: 2px solid var(--warning);
            background: linear-gradient(45deg, rgba(247, 37, 133, 0.1), rgba(247, 37, 133, 0.05));
        }

        /* Time Indicators */
        .time-indicator {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .time-normal { background: rgba(76, 201, 240, 0.2); color: #0891b2; }
        .time-warning { background: rgba(247, 37, 133, 0.2); color: #be185d; }
        .time-critical { background: rgba(255, 0, 84, 0.2); color: #721c24; }

        /* Manager Panel */
        .manager-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
            border-left: 5px solid var(--manager);
        }

        .manager-section {
            margin-bottom: 30px;
        }

        .manager-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--dark);
            font-size: 1.3rem;
        }

        .manager-section h3 i {
            color: var(--manager);
        }

        .summary-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-card h4 {
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .summary-card p {
            color: var(--text-gray);
            line-height: 1.6;
        }

        /* Flowchart Container */
        .flowchart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: auto;
        }

        .mermaid {
            text-align: center;
            margin: 0 auto;
        }

        /* Action Log */
        .action-log {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        .log-entry {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .log-icon.delivered { background: var(--success); }
        .log-icon.cancelled { background: var(--danger); }
        .log-icon.delayed { background: var(--warning); }
        .log-icon.updated { background: var(--info); }

        .log-content {
            flex: 1;
        }

        .log-time {
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-bottom: 5px;
        }

        .log-action {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 3px;
        }

        .log-details {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            transform: translateX(100%);
            opacity: 0;
            animation: slideInRight 0.3s ease forwards;
            border-left: 4px solid var(--primary);
        }

        @keyframes slideInRight {
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-left-color: var(--success); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.danger { border-left-color: var(--danger); }
        .toast.manager { border-left-color: var(--manager); }
        .toast.critical { 
            border-left-color: var(--danger);
            animation: criticalToast 0.5s ease forwards;
        }

        @keyframes criticalToast {
            0% { transform: translateX(100%); opacity: 0; }
            50% { transform: translateX(-10px); opacity: 1; }
            100% { transform: translateX(0); opacity: 1; }
        }

        /* Countdown Timer */
        .countdown-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 2500;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: none;
        }

        .countdown-timer {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .countdown-label {
            font-size: 0.9rem;
            color: var(--text-gray);
            text-align: center;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 4000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-gray);
        }

        .empty-state i {
            font-size: 5rem;
            margin-bottom: 20px;
            color: #e9ecef;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .table-wrapper {
                overflow-x: auto;
            }
        }

        /* Toggle Button */
        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }

        @media (max-width: 768px) {
            .sidebar-toggle {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <!-- Audio for Alerts -->
    <audio id="alertSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="warningSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-warning-alarm-buzzer-958.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="criticalSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-sci-fi-alarm-905.mp3" type="audio/mpeg">
    </audio>

    <!-- Countdown Timer -->
    <div class="countdown-container" id="countdownTimer">
        <div class="countdown-timer" id="countdownDisplay">00:00:00</div>
        <div class="countdown-label">End of Day Countdown</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal" style="display: flex;">
        <div class="modal">
            <div style="margin-bottom: 30px; text-align: center;">
                <i class="fas fa-chart-network" style="font-size: 4rem; color: var(--primary); margin-bottom: 15px;"></i>
                <h2 style="margin: 0; color: var(--dark);">Daily Operations Dashboard v4</h2>
                <p style="color: var(--text-gray); margin-top: 10px;">Enhanced Alerts & Sound System</p>
            </div>
            
            <div style="margin: 30px 0;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark);">User Role</label>
                    <select id="userRole" class="status-badge" style="width: 100%; padding: 12px; border: 2px solid var(--border); background: white;" onchange="toggleRoleFields()">
                        <option value="">Select Role</option>
                        <option value="agent">Agent / Operator</option>
                        <option value="manager">Manager</option>
                    </select>
                </div>
                
                <div id="agentFields" style="display: none;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark);">Agent Name</label>
                        <input type="text" id="agentNameInput" class="status-badge" placeholder="Enter your full name" style="width: 100%; padding: 12px; border: 2px solid var(--border); background: white;">
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark);">Shift Code</label>
                        <input type="password" id="shiftCodeInput" class="status-badge" placeholder="Enter shift access code" style="width: 100%; padding: 12px; border: 2px solid var(--border); background: white;">
                        <small style="color: var(--text-gray); display: block; margin-top: 5px;">Default: OPERATIONS2024</small>
                    </div>
                </div>
                
                <div id="managerFields" style="display: none;">
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark);">Manager Access Code</label>
                        <input type="password" id="managerCodeInput" class="status-badge" placeholder="Enter manager access code" style="width: 100%; padding: 12px; border: 2px solid var(--border); background: white;">
                        <small style="color: var(--text-gray); display: block; margin-top: 5px;">Default: MANAGER2024</small>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="loginUser()" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button class="btn btn-outline" style="flex: 1;" onclick="demoLogin()">
                    <i class="fas fa-magic"></i> Demo Mode
                </button>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar Toggle -->
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-chart-network" style="font-size: 1.8rem; color: #4cc9f0;"></i>
                <h2>Ops Dashboard v4</h2>
            </div>
            
            <div class="nav-list">
                <div class="nav-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="showSection('orders')">
                    <i class="fas fa-boxes"></i>
                    <span>Order Management</span>
                </div>
                <div class="nav-item" onclick="showSection('actions')">
                    <i class="fas fa-history"></i>
                    <span>Daily Actions</span>
                    <span class="manager-badge" id="actionCountBadge">0</span>
                </div>
                <div class="nav-item" onclick="showSection('manager')" id="managerNav" style="display: none;">
                    <i class="fas fa-user-tie"></i>
                    <span>Manager Panel</span>
                </div>
                <div class="nav-item" onclick="showSection('flowchart')">
                    <i class="fas fa-project-diagram"></i>
                    <span>Process Flow</span>
                </div>
                <div class="nav-item" onclick="showSection('reports')">
                    <i class="fas fa-file-export"></i>
                    <span>Daily Reports</span>
                </div>
            </div>
            
            <div class="agent-profile">
                <div class="agent-avatar" id="agentAvatar">U</div>
                <div>
                    <div style="font-weight: 600;" id="sidebarUserName">Not Logged In</div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);" id="sidebarUserRole">Guest</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Header -->
            <div class="main-header">
                <div class="header-left">
                    <h1 id="pageTitle">Operations Dashboard v4</h1>
                    <div class="session-info">
                        <span class="session-badge" id="sessionTime">Today: <span id="currentDate">Loading...</span></span>
                        <span class="session-badge" id="actionsCount">Actions: 0</span>
                        <span class="session-badge" id="ordersCount">Orders: 0</span>
                        <span class="session-badge" id="userRoleBadge" style="background: rgba(6, 214, 160, 0.1); color: var(--manager); display: none;">
                            <i class="fas fa-user-tie"></i> Manager
                        </span>
                    </div>
                </div>
                
                <div class="header-actions">
                    <div class="quick-actions">
                        <input type="file" id="excelInput" accept=".xlsx, .xls" style="display: none;" onchange="handleFileUpload(event)">
                        
                        <button class="btn btn-outline" onclick="downloadTemplate()">
                            <i class="fas fa-file-download"></i> Template
                        </button>
                        
                        <button class="btn btn-primary" onclick="document.getElementById('excelInput').click()">
                            <i class="fas fa-file-upload"></i> Import Excel
                        </button>
                        
                        <button class="btn btn-success" onclick="exportDailyReport()" id="btnExport">
                            <i class="fas fa-file-export"></i> Daily Report
                        </button>
                        
                        <button class="btn btn-manager" onclick="endOfDayProcedure()" id="btnEndOfDay" style="display: none;">
                            <i class="fas fa-flag-checkered"></i> End of Day
                        </button>
                        
                        <button class="btn btn-danger" onclick="logoutUser()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section (Default) -->
            <div id="dashboardSection">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(45deg, var(--primary), var(--secondary));">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <div class="stat-label">Today's Orders</div>
                        <div class="stat-value" id="kpiTotal">0</div>
                        <div class="stat-label" style="margin-top: 10px;" id="kpiTotalTime">Updated: --</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(45deg, var(--success), #38b000);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-label">Delivered</div>
                        <div class="stat-value" id="kpiDelivered">0</div>
                        <div class="stat-label" style="margin-top: 10px;">Success Rate: <span id="kpiSuccessRate">0%</span></div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(45deg, var(--warning), #e63946);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-label">Delayed</div>
                        <div class="stat-value" id="kpiDelayed">0</div>
                        <div class="stat-label" style="margin-top: 10px;">Avg Delay: <span id="kpiAvgDelay">0m</span></div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(45deg, var(--danger), #d00000);">
                            <i class="fas fa-ban"></i>
                        </div>
                        <div class="stat-label">Cancelled</div>
                        <div class="stat-value" id="kpiCancelled">0</div>
                        <div class="stat-label" style="margin-top: 10px;">Rate: <span id="kpiCancelRate">0%</span></div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(45deg, #7209b7, #b5179e);">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-label">Total Revenue</div>
                        <div class="stat-value" id="kpiRevenue">$0</div>
                        <div class="stat-label" style="margin-top: 10px;">Avg Order: <span id="kpiAvgOrder">$0</span></div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(45deg, #4895ef, #4361ee);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-label">Agents Active</div>
                        <div class="stat-value" id="kpiAgents">0</div>
                        <div class="stat-label" style="margin-top: 10px;">Actions: <span id="kpiActions">0</span></div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="table-wrapper">
                    <div class="table-header">
                        <h3 style="margin: 0;"><i class="fas fa-history"></i> Recent Agent Actions</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="color: var(--text-gray); font-size: 0.9rem;">Last 24 hours</span>
                            <button class="btn-icon btn-refresh" onclick="refreshDashboard()">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="action-log" id="recentActivity">
                        <!-- Recent actions will be populated here -->
                    </div>
                </div>

                <!-- Orders Table -->
                <div class="table-wrapper">
                    <div class="table-header">
                        <h3 style="margin: 0;"><i class="fas fa-list"></i> Current Orders</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="searchInput" placeholder="Search orders..." style="padding: 8px 15px; border-radius: 8px; border: 2px solid var(--border); min-width: 200px;" onkeyup="filterOrders()">
                            <select id="statusFilter" style="padding: 8px 15px; border-radius: 8px; border: 2px solid var(--border);" onchange="filterOrders()">
                                <option value="all">All Status</option>
                                <option value="Pending">Pending</option>
                                <option value="Delivered">Delivered</option>
                                <option value="Delayed">Delayed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table id="orderTable">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Order Date</th>
                                    <th>Amount</th>
                                    <th>Branch</th>
                                    <th>Status</th>
                                    <th>Time Since Added</th>
                                    <th>Reason</th>
                                    <th>Updated By</th>
                                    <th>Updated At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- Orders will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Manager Panel Section -->
            <div id="managerSection" style="display: none;">
                <div class="manager-panel">
                    <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 25px; color: var(--dark);">
                        <i class="fas fa-user-tie" style="color: var(--manager);"></i>
                        Manager Control Panel v4
                    </h2>
                    
                    <div class="manager-section">
                        <h3><i class="fas fa-chart-line"></i> Daily Performance Summary</h3>
                        <div class="summary-card">
                            <h4>Today's Overview</h4>
                            <div id="dailySummary" style="line-height: 1.8;">
                                <p>• Total Orders Processed: <strong>0</strong></p>
                                <p>• Successful Deliveries: <strong>0</strong> (<strong>0%</strong> success rate)</p>
                                <p>• Cancellation Rate: <strong>0%</strong></p>
                                <p>• Active Agents Today: <strong>0</strong></p>
                                <p>• Total Actions Recorded: <strong>0</strong></p>
                            </div>
                        </div>
                        
                        <div class="summary-card">
                            <h4>Agent Performance</h4>
                            <div id="agentPerformance">
                                <!-- Agent performance will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="manager-section">
                        <h3><i class="fas fa-tasks"></i> System Controls</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn btn-manager" onclick="generateEndOfDayReport()">
                                <i class="fas fa-file-pdf"></i> Generate EOD Report
                            </button>
                            <button class="btn btn-primary" onclick="backupSystemData()">
                                <i class="fas fa-database"></i> Backup Data
                            </button>
                            <button class="btn btn-success" onclick="exportCompleteLog()">
                                <i class="fas fa-file-excel"></i> Export Complete Log
                            </button>
                            <button class="btn btn-danger" onclick="resetForNextDay()">
                                <i class="fas fa-redo"></i> Reset for Next Day
                            </button>
                        </div>
                    </div>
                    
                    <div class="manager-section">
                        <h3><i class="fas fa-history"></i> Complete Action Log</h3>
                        <div class="action-log" id="completeActionLog">
                            <!-- Complete action log will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flowchart Section -->
            <div id="flowchartSection" style="display: none;">
                <div class="manager-panel">
                    <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 25px; color: var(--dark);">
                        <i class="fas fa-project-diagram" style="color: var(--primary);"></i>
                        Daily Process Flow Visualization
                    </h2>
                    
                    <div class="summary-card">
                        <h4>Process Overview</h4>
                        <p>This flowchart visualizes the complete daily operations workflow from agent actions through to end-of-day reporting and system reset.</p>
                    </div>
                    
                    <div class="manager-section">
                        <h3><i class="fas fa-sitemap"></i> Daily Operations Flowchart</h3>
                        <div class="flowchart-container">
                            <div class="mermaid" id="flowchart">
                                graph TD
                                    A[Agent Actions Throughout Day] --> B[Actions Stored in System]
                                    B --> C{End of Day}
                                    C --> D[Manager Reviews Data]
                                    D --> E[Generates Daily Report]
                                    E --> F[Archives Today's Data]
                                    F --> G[Resets for Next Day]
                                    G --> A
                                    
                                    style A fill:#4361ee,color:#fff
                                    style B fill:#4895ef,color:#fff
                                    style C fill:#7209b7,color:#fff
                                    style D fill:#06d6a0,color:#fff
                                    style E fill:#4cc9f0,color:#fff
                                    style F fill:#f72585,color:#fff
                                    style G fill:#ff0054,color:#fff
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn btn-primary" onclick="refreshFlowchart()">
                                <i class="fas fa-redo"></i> Refresh Flow
                            </button>
                        </div>
                    </div>
                    
                    <div class="manager-section">
                        <h3><i class="fas fa-info-circle"></i> Flow Steps Explanation</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div style="background: rgba(67, 97, 238, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary);">
                                <strong>Agent Actions</strong>
                                <p style="font-size: 0.9rem; margin-top: 5px;">Agents perform order updates throughout the day</p>
                            </div>
                            <div style="background: rgba(72, 149, 239, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info);">
                                <strong>System Storage</strong>
                                <p style="font-size: 0.9rem; margin-top: 5px;">All actions are stored with timestamps</p>
                            </div>
                            <div style="background: rgba(114, 9, 183, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--secondary);">
                                <strong>End of Day</strong>
                                <p style="font-size: 0.9rem; margin-top: 5px;">Trigger point for manager review</p>
                            </div>
                            <div style="background: rgba(6, 214, 160, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--manager);">
                                <strong>Manager Review</strong>
                                <p style="font-size: 0.9rem; margin-top: 5px;">Manager verifies all daily activities</p>
                            </div>
                            <div style="background: rgba(76, 201, 240, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success);">
                                <strong>Report Generation</strong>
                                <p style="font-size: 0.9rem; margin-top: 5px;">Daily performance report created</p>
                            </div>
                            <div style="background: rgba(247, 37, 133, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning);">
                                <strong>Data Archiving</strong>
                                <p style="font-size: 0.9rem; margin-top: 5px;">Today's data moved to archive</p>
                            </div>
                            <div style="background: rgba(255, 0, 84, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--danger);">
                                <strong>System Reset</strong>
                                <p style="font-size: 0.9rem; margin-top: 5px;">System cleared for next day operations</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Welcome to Daily Operations Dashboard v4</h3>
                <p>Import today's Excel data or use demo mode to get started</p>
                <div style="margin-top: 25px; display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="document.getElementById('excelInput').click()">
                        <i class="fas fa-upload"></i> Upload Excel
                    </button>
                    <button class="btn btn-outline" onclick="loadDemoData()">
                        <i class="fas fa-magic"></i> Load Demo Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const CONFIG = {
            SHIFT_CODE: "OPERATIONS2024",
            MANAGER_CODE: "MANAGER2024",
            DELAY_THRESHOLD_WARNING: 40, // minutes for warning
            DELAY_THRESHOLD_CRITICAL: 45, // minutes for critical alert
            DEMO_DATA_SIZE: 30,
            WORKDAY_END_HOUR: 18, // 6 PM
            WORKDAY_END_MINUTE: 0
        };

        // ================= GLOBAL STATE =================
        let state = {
            currentUser: '',
            userRole: '', // 'agent' or 'manager'
            sessionStart: null,
            dailyData: {
                orders: [],
                actions: [],
                agents: [],
                date: new Date().toISOString().split('T')[0]
            },
            previousDays: [],
            isDemo: false,
            alertSoundEnabled: true,
            warningSoundEnabled: true,
            criticalSoundEnabled: true
        };

        // ================= INITIALIZATION =================
        document.addEventListener('DOMContentLoaded', function() {
            initSession();
            updateCurrentDate();
            startCountdownTimer();
            initMermaid();
            
            // Auto-save every minute
            setInterval(saveState, 60000);
            
            // Check for alerts every 30 seconds
            setInterval(checkForAlerts, 30000);
        });

        function initSession() {
            const savedState = localStorage.getItem('ops_daily_state_v4');
            const savedUser = localStorage.getItem('ops_daily_user_v4');
            
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                state.currentUser = userData.name;
                state.userRole = userData.role;
                state.sessionStart = new Date();
                
                if (savedState) {
                    try {
                        const parsed = JSON.parse(savedState);
                        const today = new Date().toISOString().split('T')[0];
                        
                        if (parsed.date === today) {
                            state.dailyData = parsed;
                        } else {
                            // Archive yesterday's data
                            archivePreviousDay(parsed);
                            state.dailyData.date = today;
                        }
                    } catch (e) {
                        console.warn('Failed to restore session state');
                    }
                }
                
                unlockDashboard();
                loadDashboard();
            } else {
                document.getElementById('loginModal').style.display = 'flex';
            }
        }

        function archivePreviousDay(yesterdayData) {
            if (yesterdayData.orders.length > 0 || yesterdayData.actions.length > 0) {
                // Store in previous days archive
                const archive = JSON.parse(localStorage.getItem('ops_daily_archive_v4') || '[]');
                archive.push(yesterdayData);
                if (archive.length > 30) archive.shift(); // Keep last 30 days
                localStorage.setItem('ops_daily_archive_v4', JSON.stringify(archive));
                
                // Clear for new day
                state.previousDays = archive;
            }
        }

        // ================= SOUND & ALERT SYSTEM =================
        function playAlert(type = 'warning') {
            if (!state.alertSoundEnabled) return;
            
            const audioElements = {
                'warning': document.getElementById('warningSound'),
                'critical': document.getElementById('criticalSound'),
                'alert': document.getElementById('alertSound')
            };
            
            const audio = audioElements[type] || audioElements['alert'];
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Audio play failed:", e));
            }
        }

        function checkForAlerts() {
            const now = new Date().getTime();
            let hasCriticalAlert = false;
            let hasWarningAlert = false;
            
            state.dailyData.orders.forEach(order => {
                if (order.AddedAt) {
                    const minutesPassed = Math.floor((now - order.AddedAt) / 60000);
                    
                    if (minutesPassed >= CONFIG.DELAY_THRESHOLD_CRITICAL && order.status === 'Pending') {
                        hasCriticalAlert = true;
                    } else if (minutesPassed >= CONFIG.DELAY_THRESHOLD_WARNING && order.status === 'Pending') {
                        hasWarningAlert = true;
                    }
                }
            });
            
            if (hasCriticalAlert) {
                playAlert('critical');
                showToast('CRITICAL: Orders pending for >45 minutes!', 'critical');
            } else if (hasWarningAlert) {
                playAlert('warning');
                showToast('Warning: Orders pending for >40 minutes', 'warning');
            }
        }

        function showAlert(orderId, minutesPassed) {
            const message = `Order ${orderId} has been pending for ${minutesPassed} minutes!`;
            
            if (minutesPassed >= CONFIG.DELAY_THRESHOLD_CRITICAL) {
                showToast(`CRITICAL: ${message}`, 'critical');
                playAlert('critical');
            } else if (minutesPassed >= CONFIG.DELAY_THRESHOLD_WARNING) {
                showToast(`Warning: ${message}`, 'warning');
                playAlert('warning');
            }
        }

        // ================= COUNTDOWN TIMER =================
        function startCountdownTimer() {
            updateCountdownTimer();
            setInterval(updateCountdownTimer, 1000);
        }

        function updateCountdownTimer() {
            const now = new Date();
            const endTime = new Date();
            endTime.setHours(CONFIG.WORKDAY_END_HOUR, CONFIG.WORKDAY_END_MINUTE, 0, 0);
            
            // If end time has passed, show next day
            if (now > endTime) {
                endTime.setDate(endTime.getDate() + 1);
            }
            
            const diff = endTime - now;
            
            // Show countdown if less than 2 hours remaining
            if (diff <= 2 * 60 * 60 * 1000) {
                document.getElementById('countdownTimer').style.display = 'block';
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById('countdownDisplay').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Change color based on time remaining
                if (diff <= 30 * 60 * 1000) { // 30 minutes or less
                    document.getElementById('countdownDisplay').style.color = 'var(--danger)';
                } else if (diff <= 60 * 60 * 1000) { // 1 hour or less
                    document.getElementById('countdownDisplay').style.color = 'var(--warning)';
                } else {
                    document.getElementById('countdownDisplay').style.color = 'var(--primary)';
                }
            } else {
                document.getElementById('countdownTimer').style.display = 'none';
            }
        }

        // ================= AUTHENTICATION =================
        function toggleRoleFields() {
            const role = document.getElementById('userRole').value;
            document.getElementById('agentFields').style.display = role === 'agent' ? 'block' : 'none';
            document.getElementById('managerFields').style.display = role === 'manager' ? 'block' : 'none';
            document.getElementById('loginBtn').innerHTML = `<i class="fas fa-sign-in-alt"></i> ${role === 'manager' ? 'Manager Login' : 'Start Shift'}`;
        }

        function loginUser() {
            const role = document.getElementById('userRole').value;
            
            if (!role) {
                showToast('Please select a role', 'warning');
                return;
            }
            
            if (role === 'agent') {
                const name = document.getElementById('agentNameInput').value.trim();
                const code = document.getElementById('shiftCodeInput').value.trim();
                
                if (!name) {
                    showToast('Please enter agent name', 'warning');
                    return;
                }
                
                if (code !== CONFIG.SHIFT_CODE) {
                    showToast('Invalid shift access code', 'danger');
                    return;
                }
                
                state.currentUser = name;
                state.userRole = 'agent';
            } else if (role === 'manager') {
                const code = document.getElementById('managerCodeInput').value.trim();
                
                if (code !== CONFIG.MANAGER_CODE) {
                    showToast('Invalid manager access code', 'danger');
                    return;
                }
                
                state.currentUser = 'Manager';
                state.userRole = 'manager';
            }
            
            state.sessionStart = new Date();
            
            // Save user data
            localStorage.setItem('ops_daily_user_v4', JSON.stringify({
                name: state.currentUser,
                role: state.userRole,
                loginTime: new Date().toISOString()
            }));
            
            unlockDashboard();
            showToast(`Welcome, ${state.currentUser}!`, 'success');
        }

        function demoLogin() {
            state.currentUser = "Demo Agent";
            state.userRole = "agent";
            state.isDemo = true;
            
            localStorage.setItem('ops_daily_user_v4', JSON.stringify({
                name: state.currentUser,
                role: state.userRole,
                loginTime: new Date().toISOString()
            }));
            
            loadDemoData();
            unlockDashboard();
            showToast('Demo mode activated', 'success');
        }

        function unlockDashboard() {
            document.getElementById('loginModal').style.display = 'none';
            
            // Update UI based on role
            document.getElementById('sidebarUserName').textContent = state.currentUser;
            document.getElementById('sidebarUserRole').textContent = state.userRole === 'manager' ? 'Manager' : 'Operator';
            
            // Show manager nav if manager
            if (state.userRole === 'manager') {
                document.getElementById('managerNav').style.display = 'flex';
                document.getElementById('userRoleBadge').style.display = 'inline-block';
                document.getElementById('btnEndOfDay').style.display = 'inline-flex';
            }
            
            // Update avatar
            const initials = state.currentUser.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('agentAvatar').textContent = initials;
            
            loadDashboard();
        }

        function logoutUser() {
            if (confirm('Are you sure you want to logout?')) {
                // Save current state before logout
                saveState();
                
                localStorage.removeItem('ops_daily_user_v4');
                showToast('Logged out successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            }
        }

        // ================= DASHBOARD FUNCTIONS =================
        function loadDashboard() {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            
            updateCurrentDate();
            updateStats();
            updateRecentActivity();
            updateOrdersTable();
            
            if (state.userRole === 'manager') {
                updateManagerPanel();
            }
        }

        function updateCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('currentDate').textContent = dateStr;
        }

        function updateStats() {
            const orders = state.dailyData.orders;
            const actions = state.dailyData.actions;
            
            // Calculate stats
            const totalOrders = orders.length;
            const delivered = orders.filter(o => o.status === 'Delivered').length;
            const delayed = orders.filter(o => o.status === 'Delayed').length;
            const cancelled = orders.filter(o => o.status === 'Cancelled').length;
            
            const totalRevenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);
            const successRate = totalOrders > 0 ? Math.round((delivered / totalOrders) * 100) : 0;
            const cancelRate = totalOrders > 0 ? Math.round((cancelled / totalOrders) * 100) : 0;
            
            // Unique agents
            const agents = [...new Set(actions.map(a => a.agent))];
            
            // Update UI
            document.getElementById('kpiTotal').textContent = totalOrders;
            document.getElementById('kpiDelivered').textContent = delivered;
            document.getElementById('kpiDelayed').textContent = delayed;
            document.getElementById('kpiCancelled').textContent = cancelled;
            document.getElementById('kpiRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('kpiAgents').textContent = agents.length;
            document.getElementById('kpiSuccessRate').textContent = `${successRate}%`;
            document.getElementById('kpiCancelRate').textContent = `${cancelRate}%`;
            document.getElementById('kpiAvgOrder').textContent = `$${totalOrders > 0 ? (totalRevenue / totalOrders).toFixed(2) : '0'}`;
            document.getElementById('kpiActions').textContent = actions.length;
            
            // Update counts in header
            document.getElementById('ordersCount').textContent = `Orders: ${totalOrders}`;
            document.getElementById('actionsCount').textContent = `Actions: ${actions.length}`;
            document.getElementById('actionCountBadge').textContent = actions.length;
        }

        // ================= ORDER MANAGEMENT =================
        function updateOrderStatus(orderId, newStatus, reason = '') {
            const orderIndex = state.dailyData.orders.findIndex(o => o.id === orderId);
            if (orderIndex === -1) return;
            
            const order = state.dailyData.orders[orderIndex];
            const oldStatus = order.status;
            
            // Update order
            order.status = newStatus;
            order.reason = reason;
            order.updatedBy = state.currentUser;
            order.updatedAt = new Date().toISOString();
            
            // Log action
            const action = {
                id: Date.now(),
                orderId: orderId,
                action: `Status changed: ${oldStatus} → ${newStatus}`,
                agent: state.currentUser,
                timestamp: new Date().toISOString(),
                details: reason || 'No additional details',
                type: newStatus.toLowerCase()
            };
            
            state.dailyData.actions.push(action);
            
            // Track agent if new
            if (!state.dailyData.agents.includes(state.currentUser)) {
                state.dailyData.agents.push(state.currentUser);
            }
            
            updateStats();
            updateRecentActivity();
            updateOrdersTable();
            saveState();
            
            showToast(`Order ${orderId} updated to ${newStatus}`, 'success');
        }

        function cancelOrder(orderId) {
            const reason = prompt('Enter cancellation reason:');
            if (reason && reason.trim()) {
                updateOrderStatus(orderId, 'Cancelled', reason.trim());
            }
        }

        function deliverOrder(orderId) {
            updateOrderStatus(orderId, 'Delivered', 'Delivered successfully');
        }

        function delayOrder(orderId) {
            const reason = prompt('Enter delay reason:');
            if (reason && reason.trim()) {
                updateOrderStatus(orderId, 'Delayed', reason.trim());
            }
        }

        function updateOrdersTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const orders = state.dailyData.orders;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const now = new Date().getTime();
            
            const filteredOrders = orders.filter(order => {
                const matchesSearch = searchTerm === '' || 
                    order.id.toLowerCase().includes(searchTerm) ||
                    order.customer.toLowerCase().includes(searchTerm) ||
                    order.branch.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === 'all' || order.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            if (filteredOrders.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="11" style="text-align: center; padding: 40px; color: var(--text-gray);">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        <div>No orders match your filters</div>
                    </td>
                `;
                tbody.appendChild(tr);
                return;
            }
            
            filteredOrders.forEach(order => {
                const tr = document.createElement('tr');
                
                // Format dates and calculate time since added
                const orderDate = new Date(order.date);
                const updatedDate = order.updatedAt ? new Date(order.updatedAt) : null;
                const addedDate = order.AddedAt ? new Date(order.AddedAt) : orderDate;
                const minutesPassed = Math.floor((now - addedDate.getTime()) / 60000);
                
                // Determine time indicator class
                let timeClass = 'time-normal';
                if (minutesPassed >= CONFIG.DELAY_THRESHOLD_CRITICAL) {
                    timeClass = 'time-critical';
                    if (order.status === 'Pending') {
                        tr.classList.add('critical-alert');
                        showAlert(order.id, minutesPassed);
                    }
                } else if (minutesPassed >= CONFIG.DELAY_THRESHOLD_WARNING) {
                    timeClass = 'time-warning';
                    if (order.status === 'Pending') {
                        tr.classList.add('warning-alert');
                    }
                }
                
                tr.innerHTML = `
                    <td><strong>${order.id}</strong></td>
                    <td>${order.customer}</td>
                    <td>${orderDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td>$${order.total ? order.total.toFixed(2) : '0.00'}</td>
                    <td><span class="status-badge">${order.branch}</span></td>
                    <td>
                        <select class="status-badge status-${order.status.toLowerCase()}" 
                                onchange="updateOrderStatus('${order.id}', this.value, 'Status updated')"
                                style="border: none; padding: 6px 10px; cursor: pointer; font-weight: 600;">
                            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="Delayed" ${order.status === 'Delayed' ? 'selected' : ''}>Delayed</option>
                            <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <span class="time-indicator ${timeClass}">
                            ${minutesPassed}m ago
                        </span>
                    </td>
                    <td style="max-width: 200px; font-size: 0.85rem;">${order.reason || '-'}</td>
                    <td><span class="status-badge">${order.updatedBy || '-'}</span></td>
                    <td style="font-size: 0.85rem; color: var(--text-gray);">
                        ${updatedDate ? updatedDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-'}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-success" onclick="deliverOrder('${order.id}')" title="Mark as Delivered">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn-icon btn-danger" onclick="cancelOrder('${order.id}')" title="Cancel Order">
                                <i class="fas fa-ban"></i>
                            </button>
                            <button class="btn-icon btn-warning" onclick="delayOrder('${order.id}')" title="Mark as Delayed">
                                <i class="fas fa-clock"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterOrders() {
            updateOrdersTable();
        }

        // ================= ACTION LOGGING =================
        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            container.innerHTML = '';
            
            const recentActions = state.dailyData.actions.slice(-10).reverse(); // Last 10 actions
            
            if (recentActions.length === 0) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: var(--text-gray);">
                        <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <div>No actions recorded yet</div>
                    </div>
                `;
                return;
            }
            
            recentActions.forEach(action => {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                
                const actionTime = new Date(action.timestamp);
                const timeStr = actionTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                let iconType = 'updated';
                if (action.type === 'delivered') iconType = 'delivered';
                else if (action.type === 'cancelled') iconType = 'cancelled';
                else if (action.type === 'delayed') iconType = 'delayed';
                
                entry.innerHTML = `
                    <div class="log-icon ${iconType}">
                        <i class="fas fa-${iconType === 'delivered' ? 'check' : iconType === 'cancelled' ? 'ban' : iconType === 'delayed' ? 'clock' : 'edit'}"></i>
                    </div>
                    <div class="log-content">
                        <div class="log-time">${timeStr} • By ${action.agent}</div>
                        <div class="log-action">${action.action}</div>
                        <div class="log-details">Order: ${action.orderId} • ${action.details}</div>
                    </div>
                `;
                
                container.appendChild(entry);
            });
        }

        // ================= MANAGER FUNCTIONS =================
        function showSection(sectionId) {
            // Hide all sections
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('managerSection').style.display = 'none';
            document.getElementById('flowchartSection').style.display = 'none';
            
            // Show selected section
            document.getElementById(sectionId + 'Section').style.display = 'block';
            
            // Update page title
            const titles = {
                'dashboard': 'Operations Dashboard v4',
                'manager': 'Manager Control Panel v4',
                'orders': 'Order Management',
                'actions': 'Daily Actions Log',
                'flowchart': 'Process Flow Visualization',
                'reports': 'Daily Reports'
            };
            document.getElementById('pageTitle').textContent = titles[sectionId] || 'Operations Dashboard v4';
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            // Refresh section data
            if (sectionId === 'manager') {
                updateManagerPanel();
            } else if (sectionId === 'flowchart') {
                refreshFlowchart();
            }
        }

        function updateManagerPanel() {
            // Update daily summary
            const orders = state.dailyData.orders;
            const actions = state.dailyData.actions;
            
            const totalOrders = orders.length;
            const delivered = orders.filter(o => o.status === 'Delivered').length;
            const cancelled = orders.filter(o => o.status === 'Cancelled').length;
            const successRate = totalOrders > 0 ? Math.round((delivered / totalOrders) * 100) : 0;
            const cancelRate = totalOrders > 0 ? Math.round((cancelled / totalOrders) * 100) : 0;
            
            // Calculate pending orders by age
            const now = new Date().getTime();
            const pendingOrders = orders.filter(o => o.status === 'Pending');
            const criticalPending = pendingOrders.filter(o => {
                const addedTime = o.AddedAt ? new Date(o.AddedAt).getTime() : new Date(o.date).getTime();
                return Math.floor((now - addedTime) / 60000) >= CONFIG.DELAY_THRESHOLD_CRITICAL;
            }).length;
            
            const warningPending = pendingOrders.filter(o => {
                const addedTime = o.AddedAt ? new Date(o.AddedAt).getTime() : new Date(o.date).getTime();
                const minutes = Math.floor((now - addedTime) / 60000);
                return minutes >= CONFIG.DELAY_THRESHOLD_WARNING && minutes < CONFIG.DELAY_THRESHOLD_CRITICAL;
            }).length;
            
            document.getElementById('dailySummary').innerHTML = `
                <p>• Total Orders Processed: <strong>${totalOrders}</strong></p>
                <p>• Successful Deliveries: <strong>${delivered}</strong> (<strong>${successRate}%</strong> success rate)</p>
                <p>• Cancellation Rate: <strong>${cancelRate}%</strong></p>
                <p>• Pending Orders: <strong>${pendingOrders.length}</strong> 
                   (⚠️ <strong>${warningPending}</strong> warnings, 🚨 <strong>${criticalPending}</strong> critical)</p>
                <p>• Active Agents Today: <strong>${state.dailyData.agents.length}</strong></p>
                <p>• Total Actions Recorded: <strong>${actions.length}</strong></p>
            `;
            
            // Update agent performance
            const agentPerformance = document.getElementById('agentPerformance');
            agentPerformance.innerHTML = '';
            
            state.dailyData.agents.forEach(agent => {
                const agentActions = actions.filter(a => a.agent === agent);
                const agentOrders = orders.filter(o => o.updatedBy === agent);
                
                const div = document.createElement('div');
                div.style.marginBottom = '15px';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span><strong>${agent}</strong></span>
                        <span>${agentActions.length} actions</span>
                    </div>
                    <div style="background: var(--border); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${Math.min(agentActions.length * 10, 100)}%; height: 100%; background: var(--primary);"></div>
                    </div>
                `;
                agentPerformance.appendChild(div);
            });
            
            // Update complete action log
            updateCompleteActionLog();
        }

        function updateCompleteActionLog() {
            const container = document.getElementById('completeActionLog');
            container.innerHTML = '';
            
            const actions = state.dailyData.actions.slice().reverse(); // Most recent first
            
            if (actions.length === 0) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: var(--text-gray);">
                        <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <div>No actions recorded today</div>
                    </div>
                `;
                return;
            }
            
            actions.forEach(action => {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                
                const actionTime = new Date(action.timestamp);
                const timeStr = actionTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const dateStr = actionTime.toLocaleDateString();
                
                let iconType = 'updated';
                if (action.type === 'delivered') iconType = 'delivered';
                else if (action.type === 'cancelled') iconType = 'cancelled';
                else if (action.type === 'delayed') iconType = 'delayed';
                
                entry.innerHTML = `
                    <div class="log-icon ${iconType}">
                        <i class="fas fa-${iconType === 'delivered' ? 'check' : iconType === 'cancelled' ? 'ban' : iconType === 'delayed' ? 'clock' : 'edit'}"></i>
                    </div>
                    <div class="log-content">
                        <div class="log-time">${dateStr} ${timeStr} • ${action.agent}</div>
                        <div class="log-action">${action.action}</div>
                        <div class="log-details">Order: ${action.orderId} • ${action.details}</div>
                    </div>
                `;
                
                container.appendChild(entry);
            });
        }

        // ================= FLOWCHART FUNCTIONS =================
        function initMermaid() {
            mermaid.initialize({
                startOnLoad: true,
                theme: 'neutral',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                }
            });
        }

        function refreshFlowchart() {
            // Re-render the flowchart
            const element = document.getElementById('flowchart');
            if (element) {
                const graphDefinition = element.textContent;
                mermaid.render('flowchart-svg', graphDefinition, function(svgCode) {
                    element.innerHTML = svgCode;
                });
            }
        }

        // ================= FILE HANDLING =================
        function downloadTemplate() {
            const templateData = [
                ["Order ID", "Customer", "Order Date", "Total", "Branch", "Status", "Reason", "Updated By", "Updated At"],
                ["ORD-1001", "John Smith", new Date().toISOString(), 150.00, "Hamdan", "Pending", "", "", ""],
                ["ORD-1002", "Fatima Mohammed", new Date(Date.now() - 3600000).toISOString(), 89.99, "Khalidiyah", "Delivered", "Delivered on time", "Agent 1", new Date().toISOString()]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Orders");
            XLSX.writeFile(wb, "Ops_Dashboard_Template.xlsx");
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    let jsonOrders = [];
                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const rows = XLSX.utils.sheet_to_json(sheet);
                        jsonOrders = jsonOrders.concat(rows);
                    });
                    
                    // Process and normalize data
                    state.dailyData.orders = jsonOrders.map((row, index) => {
                        const getVal = (keys, defaultValue = '') => {
                            for (let key of keys) {
                                if (row[key] !== undefined && row[key] !== null && row[key] !== '') {
                                    return row[key];
                                }
                            }
                            return defaultValue;
                        };
                        
                        return {
                            id: getVal(['Order ID', 'Order no', 'id', 'ID'], `ORD-${1000 + index}`),
                            customer: getVal(['Customer', 'Cus. Name', 'Client'], 'Unknown Customer'),
                            date: getVal(['Order Date', 'Date', 'Time'], new Date().toISOString()),
                            total: parseFloat(getVal(['Total', 'Amount', 'Order Total'], 0)) || 0,
                            branch: getVal(['Branch', 'Outlet', 'Location'], 'Unknown'),
                            status: getVal(['Status', 'status', 'Order Status'], 'Pending'),
                            reason: getVal(['Reason', 'Notes', 'Comment'], ''),
                            updatedBy: getVal(['Updated By', 'Agent', 'Modified By'], ''),
                            updatedAt: getVal(['Updated At', 'Timestamp', 'Last Updated'], ''),
                            AddedAt: new Date().getTime() // Add timestamp for tracking
                        };
                    });
                    
                    // Log the import action
                    const importAction = {
                        id: Date.now(),
                        action: `Imported ${state.dailyData.orders.length} orders from Excel`,
                        agent: state.currentUser,
                        timestamp: new Date().toISOString(),
                        details: `File: ${file.name}`,
                        type: 'import'
                    };
                    
                    state.dailyData.actions.push(importAction);
                    
                    updateStats();
                    updateRecentActivity();
                    updateOrdersTable();
                    saveState();
                    
                    showToast(`Successfully imported ${state.dailyData.orders.length} orders`, 'success');
                } catch (error) {
                    showToast('Error processing file: ' + error.message, 'danger');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function loadDemoData() {
            const branches = ['Hamdan', 'Khalidiyah', 'Muroor', 'Shabiha', 'Barsha'];
            const customers = ['Ahmed Ali', 'Fatima Mohammed', 'John Smith', 'Sara Johnson', 'Mohammed Hassan'];
            
            const demoOrders = [];
            const now = new Date();
            
            for (let i = 1; i <= CONFIG.DEMO_DATA_SIZE; i++) {
                const hoursAgo = Math.floor(Math.random() * 8);
                const orderDate = new Date(now.getTime() - hoursAgo * 3600000);
                const statuses = ['Pending', 'Delivered', 'Delayed', 'Cancelled'];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                
                demoOrders.push({
                    id: `ORD-${1000 + i}`,
                    customer: customers[Math.floor(Math.random() * customers.length)],
                    date: orderDate.toISOString(),
                    total: parseFloat((Math.random() * 200 + 20).toFixed(2)),
                    branch: branches[Math.floor(Math.random() * branches.length)],
                    status: status,
                    reason: status === 'Delivered' ? 'Delivered successfully' : 
                           status === 'Cancelled' ? 'Customer cancelled' : '',
                    updatedBy: status !== 'Pending' ? 'Demo Agent' : '',
                    updatedAt: status !== 'Pending' ? orderDate.toISOString() : '',
                    AddedAt: orderDate.getTime()
                });
            }
            
            state.dailyData.orders = demoOrders;
            
            // Add some demo actions
            state.dailyData.actions = [
                {
                    id: Date.now() - 1000,
                    orderId: 'ORD-1001',
                    action: 'Status changed: Pending → Delivered',
                    agent: 'Demo Agent',
                    timestamp: new Date(now.getTime() - 2 * 3600000).toISOString(),
                    details: 'Delivered successfully',
                    type: 'delivered'
                },
                {
                    id: Date.now() - 2000,
                    orderId: 'ORD-1003',
                    action: 'Status changed: Pending → Cancelled',
                    agent: 'Demo Agent',
                    timestamp: new Date(now.getTime() - 1 * 3600000).toISOString(),
                    details: 'Customer cancelled',
                    type: 'cancelled'
                }
            ];
            
            state.dailyData.agents = ['Demo Agent'];
            
            updateStats();
            updateRecentActivity();
            updateOrdersTable();
            saveState();
            
            showToast(`Demo data loaded with ${demoOrders.length} orders`, 'success');
        }

        // ================= REPORTING =================
        function exportDailyReport() {
            showLoading();
            
            try {
                // Prepare data
                const reportData = {
                    summary: {
                        date: state.dailyData.date,
                        totalOrders: state.dailyData.orders.length,
                        delivered: state.dailyData.orders.filter(o => o.status === 'Delivered').length,
                        delayed: state.dailyData.orders.filter(o => o.status === 'Delayed').length,
                        cancelled: state.dailyData.orders.filter(o => o.status === 'Cancelled').length,
                        activeAgents: state.dailyData.agents.length,
                        totalActions: state.dailyData.actions.length,
                        generatedBy: state.currentUser,
                        generationTime: new Date().toISOString()
                    },
                    orders: state.dailyData.orders,
                    actions: state.dailyData.actions,
                    agents: state.dailyData.agents.map(agent => {
                        const agentActions = state.dailyData.actions.filter(a => a.agent === agent);
                        const agentOrders = state.dailyData.orders.filter(o => o.updatedBy === agent);
                        return {
                            agent: agent,
                            actionCount: agentActions.length,
                            orderCount: agentOrders.length,
                            lastAction: agentActions.length > 0 ? 
                                new Date(agentActions[agentActions.length - 1].timestamp).toISOString() : ''
                        };
                    })
                };
                
                // Create workbook with multiple sheets
                const wb = XLSX.utils.book_new();
                
                // Summary sheet
                const summaryRows = [
                    ["DAILY OPERATIONS REPORT v4", "", "", "", ""],
                    ["Date", reportData.summary.date, "", "", ""],
                    ["Generated By", reportData.summary.generatedBy, "", "", ""],
                    ["Generation Time", new Date(reportData.summary.generationTime).toLocaleString(), "", "", ""],
                    ["", "", "", "", ""],
                    ["SUMMARY STATISTICS", "", "", "", ""],
                    ["Total Orders", reportData.summary.totalOrders, "", "", ""],
                    ["Delivered Orders", reportData.summary.delivered, "", "", ""],
                    ["Delayed Orders", reportData.summary.delayed, "", "", ""],
                    ["Cancelled Orders", reportData.summary.cancelled, "", "", ""],
                    ["Active Agents", reportData.summary.activeAgents, "", "", ""],
                    ["Total Actions", reportData.summary.totalActions, "", "", ""],
                    ["", "", "", "", ""],
                    ["Success Rate", `${reportData.summary.totalOrders > 0 ? Math.round((reportData.summary.delivered / reportData.summary.totalOrders) * 100) : 0}%`, "", "", ""],
                    ["Cancellation Rate", `${reportData.summary.totalOrders > 0 ? Math.round((reportData.summary.cancelled / reportData.summary.totalOrders) * 100) : 0}%`, "", "", ""]
                ];
                
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryRows);
                XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");
                
                // Orders sheet
                const ordersSheet = XLSX.utils.json_to_sheet(reportData.orders);
                XLSX.utils.book_append_sheet(wb, ordersSheet, "Orders");
                
                // Actions sheet
                const actionsSheet = XLSX.utils.json_to_sheet(reportData.actions);
                XLSX.utils.book_append_sheet(wb, actionsSheet, "Actions");
                
                // Agents sheet
                const agentsSheet = XLSX.utils.json_to_sheet(reportData.agents);
                XLSX.utils.book_append_sheet(wb, agentsSheet, "Agents");
                
                // Generate filename
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                const filename = `Daily_Report_v4_${state.dailyData.date}_${timestamp}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                hideLoading();
                showToast(`Daily report exported: ${filename}`, 'success');
            } catch (error) {
                hideLoading();
                showToast('Error exporting report: ' + error.message, 'danger');
                console.error(error);
            }
        }

        function generateEndOfDayReport() {
            if (confirm('Generate End-of-Day Report and Archive Today\'s Data?')) {
                exportDailyReport();
                
                // Archive today's data
                archivePreviousDay(state.dailyData);
                
                // Reset for next day
                state.dailyData = {
                    orders: [],
                    actions: [],
                    agents: [],
                    date: new Date().toISOString().split('T')[0]
                };
                
                updateStats();
                updateRecentActivity();
                updateOrdersTable();
                saveState();
                
                showToast('End-of-Day report generated and data archived', 'manager');
            }
        }

        function endOfDayProcedure() {
            if (state.userRole !== 'manager') {
                showToast('Manager access required for End-of-Day procedure', 'warning');
                return;
            }
            
            const summary = prompt('Enter End-of-Day Summary Notes:');
            if (summary !== null) {
                // Add EOD action
                const eodAction = {
                    id: Date.now(),
                    action: 'End-of-Day Procedure Executed',
                    agent: state.currentUser,
                    timestamp: new Date().toISOString(),
                    details: summary,
                    type: 'eod'
                };
                
                state.dailyData.actions.push(eodAction);
                
                // Generate report
                generateEndOfDayReport();
            }
        }

        function backupSystemData() {
            const allData = {
                current: state.dailyData,
                previous: state.previousDays,
                systemInfo: {
                    backedUpAt: new Date().toISOString(),
                    user: state.currentUser,
                    role: state.userRole
                }
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            saveAs(blob, `ops_backup_v4_${new Date().toISOString().split('T')[0]}.json`);
            
            showToast('System data backed up successfully', 'success');
        }

        function exportCompleteLog() {
            const allData = {
                dailyData: state.dailyData,
                previousDays: state.previousDays
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            saveAs(blob, `complete_log_v4_${new Date().toISOString().split('T')[0]}.json`);
            
            showToast('Complete log exported', 'success');
        }

        function resetForNextDay() {
            if (state.userRole !== 'manager') {
                showToast('Manager access required', 'warning');
                return;
            }
            
            if (confirm('Reset system for next day? This will archive today\'s data.')) {
                archivePreviousDay(state.dailyData);
                
                state.dailyData = {
                    orders: [],
                    actions: [],
                    agents: [],
                    date: new Date().toISOString().split('T')[0]
                };
                
                updateStats();
                updateRecentActivity();
                updateOrdersTable();
                saveState();
                
                showToast('System reset for new day', 'manager');
            }
        }

        // ================= UTILITY FUNCTIONS =================
        function refreshDashboard() {
            updateStats();
            updateRecentActivity();
            updateOrdersTable();
            showToast('Dashboard refreshed', 'info');
        }

        function saveState() {
            const stateToSave = state.dailyData;
            localStorage.setItem('ops_daily_state_v4', JSON.stringify(stateToSave));
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'check-circle',
                warning: 'exclamation-triangle',
                danger: 'times-circle',
                info: 'info-circle',
                manager: 'user-tie',
                critical: 'exclamation-circle'
            };
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px; width: 100%;">
                    <i class="fas fa-${icons[type] || 'info-circle'}" style="color: var(--${type});"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--text-gray); cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        // Initialize
        initSession();
    </script>
</body>
</html>
