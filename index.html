<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الطلبات - إصدار الفصل بين الوكيل والمدير</title>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #ff0054;
            --info: #4895ef;
            --manager: #06d6a0;
            --dark: #212529;
            --light: #f8f9fa;
            --border: #dee2e6;
            --text-gray: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            min-height: 100vh;
            direction: rtl;
        }

        /* Header */
        header {
            background: linear-gradient(90deg, var(--dark) 0%, #343a40 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        header .version {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* Login Screen */
        #loginScreen {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin: 50px auto;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        #loginScreen h2 {
            color: var(--dark);
            margin-bottom: 25px;
            font-size: 1.8rem;
        }

        .login-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        .form-group select {
            cursor: pointer;
        }

        .code-note {
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-top: 5px;
            text-align: center;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        /* Dashboard Header */
        .dashboard-header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .user-details h3 {
            font-size: 1.3rem;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .user-role {
            background: var(--manager);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .user-role.agent {
            background: var(--info);
        }

        .stats-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            padding: 10px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            min-width: 120px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-gray);
            font-weight: 600;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #38b000);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--danger), #d00000);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-manager {
            background: linear-gradient(45deg, var(--manager), #06a884);
            color: white;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px;
            background: linear-gradient(90deg, #f8f9fa, #e9ecef);
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h3 {
            margin: 0;
            color: var(--dark);
            font-size: 1.2rem;
        }

        .filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filters input,
        .filters select {
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid var(--border);
            min-width: 150px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 15px;
            text-align: right;
            font-weight: 700;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
            background: #f8f9fa;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
        }

        .status-pending { background: rgba(251, 191, 36, 0.15); color: #d97706; }
        .status-delivered { background: rgba(76, 201, 240, 0.15); color: #0891b2; }
        .status-delayed { background: rgba(247, 37, 133, 0.15); color: #be185d; }
        .status-cancelled { background: rgba(108, 117, 125, 0.15); color: var(--text-gray); }

        /* Time Indicators */
        .time-indicator {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .time-normal { background: rgba(76, 201, 240, 0.2); color: #0891b2; }
        .time-warning { background: rgba(247, 37, 133, 0.2); color: #be185d; }
        .time-critical { background: rgba(255, 0, 84, 0.2); color: #721c24; }

        /* Action Buttons */
        .action-cell {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            color: white;
        }

        .btn-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-icon-success { background: var(--success); }
        .btn-icon-danger { background: var(--danger); }
        .btn-icon-warning { background: var(--warning); }

        /* Manager Panel */
        .manager-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
            border-right: 5px solid var(--manager);
        }

        .manager-section {
            margin-bottom: 25px;
        }

        .manager-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--dark);
            font-size: 1.2rem;
        }

        .manager-section h3 i {
            color: var(--manager);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            transform: translateX(-100%);
            opacity: 0;
            animation: slideInLeft 0.3s ease forwards;
            border-right: 4px solid var(--primary);
        }

        @keyframes slideInLeft {
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-right-color: var(--success); }
        .toast.warning { border-right-color: var(--warning); }
        .toast.danger { border-right-color: var(--danger); }
        .toast.manager { border-right-color: var(--manager); }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-gray);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #e9ecef;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stats-container {
                width: 100%;
                justify-content: space-between;
            }
            
            .stat-item {
                flex: 1;
                min-width: 100px;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filters {
                width: 100%;
                flex-direction: column;
            }
            
            .filters input,
            .filters select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <header>
        <h1>نظام إدارة الطلبات</h1>
        <div class="version">إصدار الفصل بين الوكيل والمدير</div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="login-icon">
                <i class="fas fa-user-lock"></i>
            </div>
            <h2>تسجيل الدخول</h2>
            
            <div class="form-group">
                <label for="userRole">الدور:</label>
                <select id="userRole" onchange="toggleRoleFields()">
                    <option value="">اختر الدور</option>
                    <option value="agent">وكيل / موظف</option>
                    <option value="manager">مدير</option>
                </select>
            </div>
            
            <div id="agentFields" style="display: none;">
                <div class="form-group">
                    <label for="agentNameInput">اسم الوكيل:</label>
                    <input type="text" id="agentNameInput" placeholder="أدخل اسمك الكامل">
                </div>
                
                <div class="form-group">
                    <label for="shiftCodeInput">كود التحول:</label>
                    <input type="password" id="shiftCodeInput" placeholder="أدخل كود التحول">
                    <div class="code-note">الكود الافتراضي: OPERATIONS2024</div>
                </div>
            </div>
            
            <div id="managerFields" style="display: none;">
                <div class="form-group">
                    <label for="managerCodeInput">كود المدير:</label>
                    <input type="password" id="managerCodeInput" placeholder="أدخل كود المدير">
                    <div class="code-note">الكود الافتراضي: MANAGER2024</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="loginUser()" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                </button>
                <button class="btn btn-outline" style="flex: 1;" onclick="demoLogin()">
                    <i class="fas fa-magic"></i> تجربة العرض
                </button>
            </div>
        </div>

        <!-- Agent Dashboard -->
        <div id="agentDashboard" class="dashboard">
            <div class="dashboard-header">
                <div class="user-info">
                    <div class="user-avatar" id="agentAvatar">و</div>
                    <div class="user-details">
                        <h3 id="agentUserName">وكيل</h3>
                        <span class="user-role agent" id="agentUserRole">وكيل</span>
                    </div>
                </div>
                
                <div class="stats-container">
                    <div class="stat-item">
                        <div class="stat-value" id="agentTotalOrders">0</div>
                        <div class="stat-label">إجمالي الطلبات</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="agentPendingOrders">0</div>
                        <div class="stat-label">طلبات معلقة</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="agentMyActions">0</div>
                        <div class="stat-label">إجراءاتي</div>
                    </div>
                </div>
                
                <button class="btn btn-danger" onclick="logoutUser()">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </div>

            <div class="action-buttons">
                <input type="file" id="excelInput" accept=".xlsx, .xls" style="display: none;" onchange="handleFileUpload(event)">
                
                <button class="btn btn-outline" onclick="downloadTemplate()">
                    <i class="fas fa-file-download"></i> تحميل النموذج
                </button>
                
                <button class="btn btn-primary" onclick="document.getElementById('excelInput').click()">
                    <i class="fas fa-file-upload"></i> رفع ملف إكسل
                </button>
                
                <button class="btn btn-success" onclick="refreshAgentDashboard()">
                    <i class="fas fa-redo"></i> تحديث
                </button>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-list"></i> الطلبات المعلقة</h3>
                    <div class="filters">
                        <input type="text" id="agentSearchInput" placeholder="بحث..." onkeyup="filterAgentOrders()">
                        <select id="agentBranchFilter" onchange="filterAgentOrders()">
                            <option value="all">كل الفروع</option>
                        </select>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table id="agentOrderTable">
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>العميل</th>
                                <th>تاريخ الطلب</th>
                                <th>المبلغ</th>
                                <th>الفرع</th>
                                <th>الوقت المنقضي</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="agentTableBody">
                            <!-- الطلبات المعلقة فقط ستظهر هنا -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-history"></i> إجراءاتي السابقة</h3>
                </div>
                
                <div style="overflow-x: auto;">
                    <table id="agentHistoryTable">
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>الحالة الجديدة</th>
                                <th>السبب</th>
                                <th>التاريخ</th>
                                <th>الوقت</th>
                            </tr>
                        </thead>
                        <tbody id="agentHistoryBody">
                            <!-- سجل إجراءات الوكيل ستظهر هنا -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Manager Dashboard -->
        <div id="managerDashboard" class="dashboard">
            <div class="dashboard-header">
                <div class="user-info">
                    <div class="user-avatar" id="managerAvatar">م</div>
                    <div class="user-details">
                        <h3 id="managerUserName">مدير</h3>
                        <span class="user-role" id="managerUserRole">مدير</span>
                    </div>
                </div>
                
                <div class="stats-container">
                    <div class="stat-item">
                        <div class="stat-value" id="managerTotalOrders">0</div>
                        <div class="stat-label">إجمالي الطلبات</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="managerDeliveredOrders">0</div>
                        <div class="stat-label">تم التسليم</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="managerCancelledOrders">0</div>
                        <div class="stat-label">ملغاة</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="managerActiveAgents">0</div>
                        <div class="stat-label">وكلاء نشطين</div>
                    </div>
                </div>
                
                <button class="btn btn-danger" onclick="logoutUser()">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </div>

            <div class="action-buttons">
                <input type="file" id="managerExcelInput" accept=".xlsx, .xls" style="display: none;" onchange="handleManagerFileUpload(event)">
                
                <button class="btn btn-outline" onclick="downloadTemplate()">
                    <i class="fas fa-file-download"></i> تحميل النموذج
                </button>
                
                <button class="btn btn-primary" onclick="document.getElementById('managerExcelInput').click()">
                    <i class="fas fa-file-upload"></i> رفع ملف إكسل
                </button>
                
                <button class="btn btn-success" onclick="exportDailyReport()">
                    <i class="fas fa-file-export"></i> تقرير يومي
                </button>
                
                <button class="btn btn-manager" onclick="archiveDay()">
                    <i class="fas fa-archive"></i> أرشفة اليوم
                </button>
            </div>

            <div class="manager-panel">
                <div class="manager-section">
                    <h3><i class="fas fa-chart-bar"></i> نظرة عامة على اليوم</h3>
                    <div id="dailySummary" style="line-height: 1.8; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <p>• إجمالي الطلبات المعالجة: <strong>0</strong></p>
                        <p>• الطلبات المسلمة: <strong>0</strong> (<strong>0%</strong> معدل النجاح)</p>
                        <p>• معدل الإلغاء: <strong>0%</strong></p>
                        <p>• الوكلاء النشطين اليوم: <strong>0</strong></p>
                        <p>• إجمالي الإجراءات المسجلة: <strong>0</strong></p>
                    </div>
                </div>
                
                <div class="manager-section">
                    <h3><i class="fas fa-users"></i> أداء الوكلاء</h3>
                    <div id="agentPerformance">
                        <!-- أداء الوكلاء سيظهر هنا -->
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-list-alt"></i> جميع الطلبات</h3>
                    <div class="filters">
                        <input type="text" id="managerSearchInput" placeholder="بحث..." onkeyup="filterManagerOrders()">
                        <select id="managerStatusFilter" onchange="filterManagerOrders()">
                            <option value="all">كل الحالات</option>
                            <option value="">معلقة</option>
                            <option value="Delivered">مسلمة</option>
                            <option value="Cancelled">ملغاة</option>
                            <option value="Delayed">متأخرة</option>
                        </select>
                        <select id="managerAgentFilter" onchange="filterManagerOrders()">
                            <option value="all">كل الوكلاء</option>
                        </select>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table id="managerOrderTable">
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>العميل</th>
                                <th>تاريخ الطلب</th>
                                <th>المبلغ</th>
                                <th>الفرع</th>
                                <th>الحالة</th>
                                <th>تم التحديث بواسطة</th>
                                <th>تاريخ التحديث</th>
                                <th>الوقت المنقضي</th>
                                <th>السبب</th>
                            </tr>
                        </thead>
                        <tbody id="managerTableBody">
                            <!-- جميع الطلبات ستظهر هنا -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-history"></i> سجل الإجراءات الكامل</h3>
                </div>
                
                <div style="overflow-x: auto; max-height: 400px;">
                    <table id="fullLogTable">
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>الإجراء</th>
                                <th>الوكيل</th>
                                <th>التاريخ</th>
                                <th>الوقت</th>
                                <th>التفاصيل</th>
                            </tr>
                        </thead>
                        <tbody id="fullLogBody">
                            <!-- سجل الإجراءات الكامل سيظهر هنا -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= التكوين الأساسي =================
        const CONFIG = {
            SHIFT_CODE: "OPERATIONS2024",
            MANAGER_CODE: "MANAGER2024",
            DELAY_THRESHOLD_WARNING: 40, // دقائق للتحذير
            DELAY_THRESHOLD_CRITICAL: 45, // دقائق للتنبيه الحرج
            WORKDAY_END_HOUR: 18, // 6 مساءً
            WORKDAY_END_MINUTE: 0
        };

        // ================= الحالة العامة =================
        let state = {
            currentUser: null,
            userRole: '', // 'agent' أو 'manager'
            sessionStart: null,
            allOrders: [],
            actionLog: [],
            agents: []
        };

        // ================= التهيئة =================
        document.addEventListener('DOMContentLoaded', function() {
            loadStateFromStorage();
            
            // النسخ الاحتياطي التلقائي كل دقيقة
            setInterval(saveState, 60000);
        });

        function loadStateFromStorage() {
            // تحميل جميع الطلبات من localStorage
            const savedOrders = localStorage.getItem('ops_all_orders');
            const savedLog = localStorage.getItem('ops_action_log');
            const savedAgents = localStorage.getItem('ops_agents');
            const savedUser = localStorage.getItem('ops_current_user');
            
            if (savedOrders) {
                state.allOrders = JSON.parse(savedOrders);
            }
            
            if (savedLog) {
                state.actionLog = JSON.parse(savedLog);
            }
            
            if (savedAgents) {
                state.agents = JSON.parse(savedAgents);
            }
            
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                state.currentUser = userData.name;
                state.userRole = userData.role;
                state.sessionStart = new Date(userData.loginTime);
                
                showDashboard();
            }
        }

        function saveState() {
            // حفظ جميع البيانات في localStorage
            localStorage.setItem('ops_all_orders', JSON.stringify(state.allOrders));
            localStorage.setItem('ops_action_log', JSON.stringify(state.actionLog));
            localStorage.setItem('ops_agents', JSON.stringify(state.agents));
            
            if (state.currentUser) {
                localStorage.setItem('ops_current_user', JSON.stringify({
                    name: state.currentUser,
                    role: state.userRole,
                    loginTime: state.sessionStart
                }));
            }
        }

        // ================= نظام تسجيل الدخول =================
        function toggleRoleFields() {
            const role = document.getElementById('userRole').value;
            document.getElementById('agentFields').style.display = role === 'agent' ? 'block' : 'none';
            document.getElementById('managerFields').style.display = role === 'manager' ? 'block' : 'none';
            document.getElementById('loginBtn').innerHTML = `<i class="fas fa-sign-in-alt"></i> ${role === 'manager' ? 'تسجيل دخول المدير' : 'بدء التحول'}`;
        }

        function loginUser() {
            const role = document.getElementById('userRole').value;
            
            if (!role) {
                showToast('الرجاء اختيار الدور', 'warning');
                return;
            }
            
            if (role === 'agent') {
                const name = document.getElementById('agentNameInput').value.trim();
                const code = document.getElementById('shiftCodeInput').value.trim();
                
                if (!name) {
                    showToast('الرجاء إدخال اسم الوكيل', 'warning');
                    return;
                }
                
                if (code !== CONFIG.SHIFT_CODE) {
                    showToast('كود التحول غير صحيح', 'danger');
                    return;
                }
                
                state.currentUser = name;
                state.userRole = 'agent';
                
                // إضافة الوكيل إلى قائمة الوكلاء إذا لم يكن موجوداً
                if (!state.agents.includes(name)) {
                    state.agents.push(name);
                }
            } else if (role === 'manager') {
                const code = document.getElementById('managerCodeInput').value.trim();
                
                if (code !== CONFIG.MANAGER_CODE) {
                    showToast('كود المدير غير صحيح', 'danger');
                    return;
                }
                
                state.currentUser = 'المدير';
                state.userRole = 'manager';
            }
            
            state.sessionStart = new Date();
            saveState();
            
            showToast(`مرحباً، ${state.currentUser}!`, 'success');
            showDashboard();
        }

        function demoLogin() {
            state.currentUser = "وكيل تجريبي";
            state.userRole = "agent";
            
            // إضافة الوكيل التجريبي إذا لم يكن موجوداً
            if (!state.agents.includes(state.currentUser)) {
                state.agents.push(state.currentUser);
            }
            
            // تحميل بيانات تجريبية
            loadDemoData();
            
            state.sessionStart = new Date();
            saveState();
            
            showToast('تم تفعيل وضع التجربة', 'success');
            showDashboard();
        }

        function logoutUser() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                // حفظ الحالة الحالية قبل الخروج
                saveState();
                
                localStorage.removeItem('ops_current_user');
                showToast('تم تسجيل الخروج بنجاح', 'success');
                setTimeout(() => location.reload(), 1000);
            }
        }

        // ================= عرض لوحة التحكم =================
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            
            if (state.userRole === 'agent') {
                document.getElementById('agentDashboard').classList.add('active');
                document.getElementById('managerDashboard').classList.remove('active');
                refreshAgentDashboard();
            } else if (state.userRole === 'manager') {
                document.getElementById('managerDashboard').classList.add('active');
                document.getElementById('agentDashboard').classList.remove('active');
                refreshManagerDashboard();
            }
            
            // تحديث معلومات المستخدم
            updateUserInfo();
        }

        function updateUserInfo() {
            const initials = state.currentUser.split(' ').map(n => n[0]).join('').toUpperCase();
            
            if (state.userRole === 'agent') {
                document.getElementById('agentAvatar').textContent = initials;
                document.getElementById('agentUserName').textContent = state.currentUser;
                document.getElementById('agentUserRole').textContent = 'وكيل';
            } else {
                document.getElementById('managerAvatar').textContent = initials;
                document.getElementById('managerUserName').textContent = state.currentUser;
                document.getElementById('managerUserRole').textContent = 'مدير';
            }
        }

        // ================= لوحة الوكيل =================
        function refreshAgentDashboard() {
            updateAgentStats();
            updateAgentOrdersTable();
            updateAgentHistory();
        }

        function updateAgentStats() {
            // الطلبات المعلقة فقط (الحالة فارغة)
            const pendingOrders = state.allOrders.filter(order => order.Status === "" || !order.Status);
            
            // إجراءات الوكيل الحالي
            const myActions = state.actionLog.filter(action => action.MarkedBy === state.currentUser);
            
            document.getElementById('agentTotalOrders').textContent = state.allOrders.length;
            document.getElementById('agentPendingOrders').textContent = pendingOrders.length;
            document.getElementById('agentMyActions').textContent = myActions.length;
        }

        function updateAgentOrdersTable() {
            const tbody = document.getElementById('agentTableBody');
            tbody.innerHTML = '';
            
            // الوكيل يرى فقط الطلبات غير المعلمة (الحالة فارغة)
            const pendingOrders = state.allOrders.filter(order => 
                (order.Status === "" || !order.Status) && 
                !isOrderMarkedByCurrentAgent(order)
            );
            
            const searchTerm = document.getElementById('agentSearchInput').value.toLowerCase();
            const branchFilter = document.getElementById('agentBranchFilter').value;
            const now = new Date().getTime();
            
            // تحديث قائمة الفروع
            updateBranchFilter('agentBranchFilter', pendingOrders);
            
            const filteredOrders = pendingOrders.filter(order => {
                const matchesSearch = searchTerm === '' || 
                    order.OrderID.toLowerCase().includes(searchTerm) ||
                    (order.Customer && order.Customer.toLowerCase().includes(searchTerm));
                
                const matchesBranch = branchFilter === 'all' || order.Branch === branchFilter;
                
                return matchesSearch && matchesBranch;
            });
            
            if (filteredOrders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-gray);">
                            <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px; display: block; color: var(--success);"></i>
                            <div>لا توجد طلبات معلقة حالياً</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredOrders.forEach(order => {
                const tr = document.createElement('tr');
                
                // حساب الوقت المنقضي
                const addedDate = order.AddedAt ? new Date(order.AddedAt) : new Date(order.OrderDate || Date.now());
                const minutesPassed = Math.floor((now - addedDate.getTime()) / 60000);
                
                // تحديد فئة الوقت
                let timeClass = 'time-normal';
                if (minutesPassed >= CONFIG.DELAY_THRESHOLD_CRITICAL) {
                    timeClass = 'time-critical';
                } else if (minutesPassed >= CONFIG.DELAY_THRESHOLD_WARNING) {
                    timeClass = 'time-warning';
                }
                
                tr.innerHTML = `
                    <td><strong>${order.OrderID}</strong></td>
                    <td>${order.Customer || 'عميل غير معروف'}</td>
                    <td>${addedDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td>${order.Total ? `$${order.Total.toFixed(2)}` : '$0.00'}</td>
                    <td><span class="status-badge">${order.Branch || 'غير محدد'}</span></td>
                    <td>
                        <span class="time-indicator ${timeClass}">
                            ${minutesPassed} دقيقة
                        </span>
                    </td>
                    <td>
                        <div class="action-cell">
                            <button class="btn-icon btn-icon-success" onclick="markOrderAs('${order.OrderID}', 'Delivered')" title="تم التسليم">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn-icon btn-icon-danger" onclick="markOrderAs('${order.OrderID}', 'Cancelled')" title="إلغاء">
                                <i class="fas fa-ban"></i>
                            </button>
                            <button class="btn-icon btn-icon-warning" onclick="markOrderAs('${order.OrderID}', 'Delayed')" title="تأخير">
                                <i class="fas fa-clock"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function isOrderMarkedByCurrentAgent(order) {
            // التحقق إذا كان الطلب قد تم وسمه من قبل الوكيل الحالي
            if (!order.MarkedBy) return false;
            return order.MarkedBy === state.currentUser;
        }

        function updateAgentHistory() {
            const tbody = document.getElementById('agentHistoryBody');
            tbody.innerHTML = '';
            
            // عرض إجراءات الوكيل الحالي فقط
            const myActions = state.actionLog
                .filter(action => action.MarkedBy === state.currentUser)
                .slice(-20) // آخر 20 إجراء
                .reverse(); // الأحدث أولاً
            
            if (myActions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px; color: var(--text-gray);">
                            <i class="fas fa-history" style="font-size: 2rem; margin-bottom: 10px; display: block; opacity: 0.3;"></i>
                            <div>لا توجد إجراءات سابقة</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            myActions.forEach(action => {
                const tr = document.createElement('tr');
                const actionDate = new Date(action.Timestamp || action.AddedAt || Date.now());
                
                tr.innerHTML = `
                    <td><strong>${action.OrderID}</strong></td>
                    <td><span class="status-badge status-${action.Status.toLowerCase()}">${action.Status}</span></td>
                    <td>${action.Reason || '-'}</td>
                    <td>${actionDate.toLocaleDateString('ar-SA')}</td>
                    <td>${actionDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterAgentOrders() {
            updateAgentOrdersTable();
        }

        // ================= لوحة المدير =================
        function refreshManagerDashboard() {
            updateManagerStats();
            updateManagerOrdersTable();
            updateManagerLog();
            updateAgentPerformance();
        }

        function updateManagerStats() {
            const totalOrders = state.allOrders.length;
            const deliveredOrders = state.allOrders.filter(o => o.Status === 'Delivered').length;
            const cancelledOrders = state.allOrders.filter(o => o.Status === 'Cancelled').length;
            
            document.getElementById('managerTotalOrders').textContent = totalOrders;
            document.getElementById('managerDeliveredOrders').textContent = deliveredOrders;
            document.getElementById('managerCancelledOrders').textContent = cancelledOrders;
            document.getElementById('managerActiveAgents').textContent = state.agents.length;
            
            // تحديث النظرة العامة
            const pendingOrders = state.allOrders.filter(o => o.Status === "" || !o.Status).length;
            const successRate = totalOrders > 0 ? Math.round((deliveredOrders / totalOrders) * 100) : 0;
            const cancelRate = totalOrders > 0 ? Math.round((cancelledOrders / totalOrders) * 100) : 0;
            
            document.getElementById('dailySummary').innerHTML = `
                <p>• إجمالي الطلبات المعالجة: <strong>${totalOrders}</strong></p>
                <p>• الطلبات المسلمة: <strong>${deliveredOrders}</strong> (<strong>${successRate}%</strong> معدل النجاح)</p>
                <p>• الطلبات المعلقة: <strong>${pendingOrders}</strong></p>
                <p>• معدل الإلغاء: <strong>${cancelRate}%</strong></p>
                <p>• الوكلاء النشطين: <strong>${state.agents.length}</strong></p>
                <p>• إجمالي الإجراءات المسجلة: <strong>${state.actionLog.length}</strong></p>
            `;
        }

        function updateManagerOrdersTable() {
            const tbody = document.getElementById('managerTableBody');
            tbody.innerHTML = '';
            
            const searchTerm = document.getElementById('managerSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('managerStatusFilter').value;
            const agentFilter = document.getElementById('managerAgentFilter').value;
            const now = new Date().getTime();
            
            // تحديث قائمة الوكلاء
            updateAgentFilter('managerAgentFilter');
            
            // تحديث قائمة الفروع للمدير إذا لزم الأمر
            
            const filteredOrders = state.allOrders.filter(order => {
                const matchesSearch = searchTerm === '' || 
                    order.OrderID.toLowerCase().includes(searchTerm) ||
                    (order.Customer && order.Customer.toLowerCase().includes(searchTerm));
                
                const matchesStatus = statusFilter === 'all' || 
                    (statusFilter === '' && (!order.Status || order.Status === "")) ||
                    order.Status === statusFilter;
                
                const matchesAgent = agentFilter === 'all' || order.MarkedBy === agentFilter;
                
                return matchesSearch && matchesStatus && matchesAgent;
            });
            
            if (filteredOrders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: var(--text-gray);">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            <div>لا توجد طلبات تطابق معايير البحث</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredOrders.forEach(order => {
                const tr = document.createElement('tr');
                
                // تنسيق التواريخ
                const orderDate = new Date(order.OrderDate || order.AddedAt || Date.now());
                const updatedDate = order.Timestamp ? new Date(order.Timestamp) : null;
                const minutesPassed = Math.floor((now - orderDate.getTime()) / 60000);
                
                // تحديد فئة الوقت
                let timeClass = 'time-normal';
                if (minutesPassed >= CONFIG.DELAY_THRESHOLD_CRITICAL) {
                    timeClass = 'time-critical';
                } else if (minutesPassed >= CONFIG.DELAY_THRESHOLD_WARNING) {
                    timeClass = 'time-warning';
                }
                
                // تحديد فئة الحالة
                let statusClass = 'status-pending';
                if (order.Status === 'Delivered') statusClass = 'status-delivered';
                else if (order.Status === 'Cancelled') statusClass = 'status-cancelled';
                else if (order.Status === 'Delayed') statusClass = 'status-delayed';
                
                tr.innerHTML = `
                    <td><strong>${order.OrderID}</strong></td>
                    <td>${order.Customer || 'عميل غير معروف'}</td>
                    <td>${orderDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td>${order.Total ? `$${order.Total.toFixed(2)}` : '$0.00'}</td>
                    <td><span class="status-badge">${order.Branch || 'غير محدد'}</span></td>
                    <td><span class="status-badge ${statusClass}">${order.Status || 'معلق'}</span></td>
                    <td>${order.MarkedBy || '-'}</td>
                    <td>${updatedDate ? updatedDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-'}</td>
                    <td>
                        <span class="time-indicator ${timeClass}">
                            ${minutesPassed} دقيقة
                        </span>
                    </td>
                    <td style="max-width: 200px; font-size: 0.85rem;">${order.Reason || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateManagerLog() {
            const tbody = document.getElementById('fullLogBody');
            tbody.innerHTML = '';
            
            // عرض جميع الإجراءات، الأحدث أولاً
            const allActions = state.actionLog.slice().reverse();
            
            if (allActions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: var(--text-gray);">
                            <i class="fas fa-clipboard-list" style="font-size: 2rem; margin-bottom: 10px; display: block; opacity: 0.3;"></i>
                            <div>لا توجد إجراءات مسجلة</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            allActions.forEach(action => {
                const tr = document.createElement('tr');
                const actionDate = new Date(action.Timestamp || action.AddedAt || Date.now());
                
                tr.innerHTML = `
                    <td><strong>${action.OrderID}</strong></td>
                    <td>${action.Status || 'تحديث'}</td>
                    <td>${action.MarkedBy || 'غير معروف'}</td>
                    <td>${actionDate.toLocaleDateString('ar-SA')}</td>
                    <td>${actionDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td>${action.Reason || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateAgentPerformance() {
            const container = document.getElementById('agentPerformance');
            container.innerHTML = '';
            
            if (state.agents.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); text-align: center;">لا يوجد وكلاء نشطين</p>';
                return;
            }
            
            state.agents.forEach(agent => {
                const agentActions = state.actionLog.filter(a => a.MarkedBy === agent);
                const agentOrders = state.allOrders.filter(o => o.MarkedBy === agent);
                
                const div = document.createElement('div');
                div.style.marginBottom = '15px';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span><strong>${agent}</strong></span>
                        <span>${agentActions.length} إجراء</span>
                    </div>
                    <div style="background: var(--border); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${Math.min(agentActions.length * 10, 100)}%; height: 100%; background: var(--primary);"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateAgentFilter(selectId) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            select.innerHTML = '<option value="all">كل الوكلاء</option>';
            state.agents.forEach(agent => {
                select.innerHTML += `<option value="${agent}">${agent}</option>`;
            });
            
            // الحفاظ على القيمة المحددة سابقاً
            select.value = currentValue;
        }

        function updateBranchFilter(selectId, orders) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // استخراج الفروع الفريدة من الطلبات
            const branches = [...new Set(orders.map(order => order.Branch || 'غير محدد'))];
            
            select.innerHTML = '<option value="all">كل الفروع</option>';
            branches.forEach(branch => {
                select.innerHTML += `<option value="${branch}">${branch}</option>`;
            });
            
            // الحفاظ على القيمة المحددة سابقاً
            select.value = currentValue;
        }

        function filterManagerOrders() {
            updateManagerOrdersTable();
        }

        // ================= معالجة الطلبات =================
        function markOrderAs(orderId, status) {
            if (state.userRole !== 'agent') {
                showToast('يجب أن تكون وكيلاً لتحديث حالة الطلب', 'warning');
                return;
            }
            
            let reason = '';
            if (status === 'Cancelled' || status === 'Delayed') {
                reason = prompt(`يرجى إدخال سبب ${status === 'Cancelled' ? 'الإلغاء' : 'التأخير'}:`);
                if (reason === null || reason.trim() === '') {
                    showToast('يجب إدخال سبب', 'warning');
                    return;
                }
                reason = reason.trim();
            } else {
                reason = 'تم التسليم بنجاح';
            }
            
            // البحث عن الطلب
            const orderIndex = state.allOrders.findIndex(o => o.OrderID === orderId);
            if (orderIndex === -1) {
                showToast('الطلب غير موجود', 'danger');
                return;
            }
            
            const order = state.allOrders[orderIndex];
            const oldStatus = order.Status || '';
            
            // تحديث الطلب
            order.Status = status;
            order.MarkedBy = state.currentUser;
            order.Timestamp = new Date().toISOString();
            order.Reason = reason;
            order.UpdatedAt = new Date().getTime();
            
            // إضافة إلى سجل الإجراءات
            const action = {
                OrderID: orderId,
                Status: status,
                MarkedBy: state.currentUser,
                Timestamp: new Date().toISOString(),
                Reason: reason,
                AddedAt: new Date().getTime(),
                OldStatus: oldStatus
            };
            
            state.actionLog.push(action);
            
            // حفظ الحالة
            saveState();
            
            // تحديث الواجهة
            if (state.userRole === 'agent') {
                refreshAgentDashboard();
            } else {
                refreshManagerDashboard();
            }
            
            showToast(`تم تحديث الطلب ${orderId} إلى "${status}"`, 'success');
        }

        // ================= معالجة الملفات =================
        function downloadTemplate() {
            const templateData = [
                ["OrderID", "Customer", "OrderDate", "Total", "Branch", "Status", "Reason", "MarkedBy", "Timestamp"],
                ["ORD-1001", "أحمد علي", new Date().toISOString(), 150.00, "حمدان", "", "", "", ""],
                ["ORD-1002", "فاطمة محمد", new Date(Date.now() - 3600000).toISOString(), 89.99, "خالدية", "Delivered", "تم التسليم في الوقت المحدد", "وكيل 1", new Date().toISOString()]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "الطلبات");
            XLSX.writeFile(wb, "نموذج_الطلبات.xlsx");
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    let jsonOrders = [];
                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const rows = XLSX.utils.sheet_to_json(sheet);
                        jsonOrders = jsonOrders.concat(rows);
                    });
                    
                    // معالجة وتنسيق البيانات
                    const newOrders = jsonOrders.map((row, index) => {
                        // البحث عن القيمة من مفاتيح مختلفة محتملة
                        const getVal = (keys, defaultValue = '') => {
                            for (let key of keys) {
                                if (row[key] !== undefined && row[key] !== null && row[key] !== '') {
                                    return row[key];
                                }
                            }
                            return defaultValue;
                        };
                        
                        return {
                            OrderID: getVal(['OrderID', 'Order no', 'id', 'ID', 'رقم الطلب'], `ORD-${1000 + index}`),
                            Customer: getVal(['Customer', 'Cus. Name', 'Client', 'العميل'], 'عميل غير معروف'),
                            OrderDate: getVal(['OrderDate', 'Date', 'Time', 'تاريخ الطلب'], new Date().toISOString()),
                            Total: parseFloat(getVal(['Total', 'Amount', 'Order Total', 'المبلغ'], 0)) || 0,
                            Branch: getVal(['Branch', 'Outlet', 'Location', 'الفرع'], 'غير محدد'),
                            Status: getVal(['Status', 'status', 'Order Status', 'الحالة'], ''),
                            Reason: getVal(['Reason', 'Notes', 'Comment', 'السبب'], ''),
                            MarkedBy: getVal(['MarkedBy', 'Agent', 'Modified By', 'تم التحديث بواسطة'], ''),
                            Timestamp: getVal(['Timestamp', 'Last Updated', 'تاريخ التحديث'], ''),
                            AddedAt: new Date().getTime()
                        };
                    });
                    
                    // إضافة الطلبات الجديدة فقط (غير مكررة)
                    newOrders.forEach(newOrder => {
                        const existingIndex = state.allOrders.findIndex(o => o.OrderID === newOrder.OrderID);
                        if (existingIndex === -1) {
                            state.allOrders.push(newOrder);
                        }
                    });
                    
                    // إضافة إجراء الاستيراد إلى السجل
                    const importAction = {
                        OrderID: 'SYSTEM',
                        Status: 'Import',
                        MarkedBy: state.currentUser,
                        Timestamp: new Date().toISOString(),
                        Reason: `تم استيراد ${newOrders.length} طلب من الملف: ${file.name}`,
                        AddedAt: new Date().getTime()
                    };
                    
                    state.actionLog.push(importAction);
                    
                    // حفظ الحالة
                    saveState();
                    
                    // تحديث الواجهة
                    if (state.userRole === 'agent') {
                        refreshAgentDashboard();
                    } else {
                        refreshManagerDashboard();
                    }
                    
                    showToast(`تم استيراد ${newOrders.length} طلب بنجاح`, 'success');
                } catch (error) {
                    showToast('خطأ في معالجة الملف: ' + error.message, 'danger');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function handleManagerFileUpload(event) {
            handleFileUpload(event);
        }

        // ================= بيانات تجريبية =================
        function loadDemoData() {
            const branches = ['حمدان', 'خالدية', 'مروع', 'شبهة', 'برشاء'];
            const customers = ['أحمد علي', 'فاطمة محمد', 'محمد حسن', 'سارة أحمد', 'علي خالد'];
            
            const demoOrders = [];
            const now = new Date();
            
            // إنشاء 20 طلب تجريبي
            for (let i = 1; i <= 20; i++) {
                const hoursAgo = Math.floor(Math.random() * 8);
                const orderDate = new Date(now.getTime() - hoursAgo * 3600000);
                const statuses = ['', 'Delivered', 'Cancelled', 'Delayed'];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const markedBy = status !== '' ? (Math.random() > 0.5 ? 'وكيل 1' : 'وكيل 2') : '';
                
                demoOrders.push({
                    OrderID: `ORD-DEMO-${1000 + i}`,
                    Customer: customers[Math.floor(Math.random() * customers.length)],
                    OrderDate: orderDate.toISOString(),
                    Total: parseFloat((Math.random() * 200 + 20).toFixed(2)),
                    Branch: branches[Math.floor(Math.random() * branches.length)],
                    Status: status,
                    Reason: status === 'Delivered' ? 'تم التسليم بنجاح' : 
                           status === 'Cancelled' ? 'ألغى العميل الطلب' : 
                           status === 'Delayed' ? 'تأخير في التسليم' : '',
                    MarkedBy: markedBy,
                    Timestamp: status !== '' ? orderDate.toISOString() : '',
                    AddedAt: orderDate.getTime()
                });
            }
            
            // إضافة الطلبات التجريبية
            demoOrders.forEach(order => {
                const existingIndex = state.allOrders.findIndex(o => o.OrderID === order.OrderID);
                if (existingIndex === -1) {
                    state.allOrders.push(order);
                }
            });
            
            // إضافة بعض إجراءات الوكلاء
            const demoActions = [
                {
                    OrderID: 'ORD-DEMO-1001',
                    Status: 'Delivered',
                    MarkedBy: 'وكيل 1',
                    Timestamp: new Date(now.getTime() - 2 * 3600000).toISOString(),
                    Reason: 'تم التسليم في الوقت المحدد',
                    AddedAt: new Date(now.getTime() - 2 * 3600000).getTime()
                },
                {
                    OrderID: 'ORD-DEMO-1003',
                    Status: 'Cancelled',
                    MarkedBy: 'وكيل 2',
                    Timestamp: new Date(now.getTime() - 1 * 3600000).toISOString(),
                    Reason: 'طلب العميل الإلغاء',
                    AddedAt: new Date(now.getTime() - 1 * 3600000).getTime()
                }
            ];
            
            demoActions.forEach(action => {
                const existingIndex = state.actionLog.findIndex(a => 
                    a.OrderID === action.OrderID && a.Status === action.Status
                );
                if (existingIndex === -1) {
                    state.actionLog.push(action);
                }
            });
            
            // إضافة وكلاء تجريبيين
            if (!state.agents.includes('وكيل 1')) state.agents.push('وكيل 1');
            if (!state.agents.includes('وكيل 2')) state.agents.push('وكيل 2');
            
            // حفظ الحالة
            saveState();
            
            showToast('تم تحميل البيانات التجريبية بنجاح', 'success');
        }

        // ================= التقارير =================
        function exportDailyReport() {
            showLoading();
            
            try {
                // إعداد البيانات
                const reportData = {
                    summary: {
                        date: new Date().toLocaleDateString('ar-SA'),
                        totalOrders: state.allOrders.length,
                        delivered: state.allOrders.filter(o => o.Status === 'Delivered').length,
                        delayed: state.allOrders.filter(o => o.Status === 'Delayed').length,
                        cancelled: state.allOrders.filter(o => o.Status === 'Cancelled').length,
                        pending: state.allOrders.filter(o => !o.Status || o.Status === "").length,
                        activeAgents: state.agents.length,
                        totalActions: state.actionLog.length,
                        generatedBy: state.currentUser,
                        generationTime: new Date().toISOString()
                    },
                    orders: state.allOrders,
                    actions: state.actionLog,
                    agents: state.agents.map(agent => {
                        const agentActions = state.actionLog.filter(a => a.MarkedBy === agent);
                        const agentOrders = state.allOrders.filter(o => o.MarkedBy === agent);
                        return {
                            agent: agent,
                            actionCount: agentActions.length,
                            orderCount: agentOrders.length,
                            lastAction: agentActions.length > 0 ? 
                                new Date(agentActions[agentActions.length - 1].Timestamp).toISOString() : ''
                        };
                    })
                };
                
                // إنشاء ملف إكسل
                const wb = XLSX.utils.book_new();
                
                // ورقة الملخص
                const summaryRows = [
                    ["تقرير العمليات اليومي", "", "", "", ""],
                    ["التاريخ", reportData.summary.date, "", "", ""],
                    ["تم الإنشاء بواسطة", reportData.summary.generatedBy, "", "", ""],
                    ["وقت الإنشاء", new Date(reportData.summary.generationTime).toLocaleString(), "", "", ""],
                    ["", "", "", "", ""],
                    ["إحصائيات الملخص", "", "", "", ""],
                    ["إجمالي الطلبات", reportData.summary.totalOrders, "", "", ""],
                    ["الطلبات المسلمة", reportData.summary.delivered, "", "", ""],
                    ["الطلبات المتأخرة", reportData.summary.delayed, "", "", ""],
                    ["الطلبات الملغاة", reportData.summary.cancelled, "", "", ""],
                    ["الطلبات المعلقة", reportData.summary.pending, "", "", ""],
                    ["الوكلاء النشطين", reportData.summary.activeAgents, "", "", ""],
                    ["إجمالي الإجراءات", reportData.summary.totalActions, "", "", ""],
                    ["", "", "", "", ""],
                    ["معدل النجاح", `${reportData.summary.totalOrders > 0 ? Math.round((reportData.summary.delivered / reportData.summary.totalOrders) * 100) : 0}%`, "", "", ""],
                    ["معدل الإلغاء", `${reportData.summary.totalOrders > 0 ? Math.round((reportData.summary.cancelled / reportData.summary.totalOrders) * 100) : 0}%`, "", "", ""]
                ];
                
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryRows);
                XLSX.utils.book_append_sheet(wb, wsSummary, "الملخص");
                
                // ورقة الطلبات
                const ordersSheet = XLSX.utils.json_to_sheet(reportData.orders);
                XLSX.utils.book_append_sheet(wb, ordersSheet, "الطلبات");
                
                // ورقة الإجراءات
                const actionsSheet = XLSX.utils.json_to_sheet(reportData.actions);
                XLSX.utils.book_append_sheet(wb, actionsSheet, "الإجراءات");
                
                // ورقة الوكلاء
                const agentsSheet = XLSX.utils.json_to_sheet(reportData.agents);
                XLSX.utils.book_append_sheet(wb, agentsSheet, "الوكلاء");
                
                // إنشاء اسم الملف
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                const filename = `تقرير_يومي_${new Date().toISOString().split('T')[0]}_${timestamp}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                hideLoading();
                showToast(`تم تصدير التقرير اليومي: ${filename}`, 'success');
            } catch (error) {
                hideLoading();
                showToast('خطأ في تصدير التقرير: ' + error.message, 'danger');
                console.error(error);
            }
        }

        function archiveDay() {
            if (confirm('هل تريد أرشفة بيانات اليوم وبدء يوم جديد؟')) {
                // إنشاء نسخة أرشيفية
                const archiveData = {
                    date: new Date().toISOString().split('T')[0],
                    orders: [...state.allOrders],
                    actions: [...state.actionLog],
                    agents: [...state.agents],
                    archivedAt: new Date().toISOString()
                };
                
                // حفظ الأرشيف
                const archive = JSON.parse(localStorage.getItem('ops_archive') || '[]');
                archive.push(archiveData);
                if (archive.length > 30) archive.shift(); // الاحتفاظ بآخر 30 يوم
                localStorage.setItem('ops_archive', JSON.stringify(archive));
                
                // إعادة تعيين البيانات الحالية (الحفاظ على الهيكل)
                state.allOrders = state.allOrders.map(order => ({
                    ...order,
                    Status: '',
                    MarkedBy: '',
                    Timestamp: '',
                    Reason: '',
                    UpdatedAt: null
                }));
                
                // الاحتفاظ بسجل الإجراءات (للمدير)
                // state.actionLog = []; // يمكن تفريغه إذا أردت
                
                // حفظ الحالة الجديدة
                saveState();
                
                // تحديث الواجهة
                if (state.userRole === 'manager') {
                    refreshManagerDashboard();
                }
                
                showToast('تم أرشفة بيانات اليوم وبدء يوم جديد', 'manager');
            }
        }

        // ================= وظائف مساعدة =================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'check-circle',
                warning: 'exclamation-triangle',
                danger: 'times-circle',
                info: 'info-circle',
                manager: 'user-tie'
            };
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px; width: 100%;">
                    <i class="fas fa-${icons[type] || 'info-circle'}" style="color: var(--${type});"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--text-gray); cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            
            // الإزالة التلقائية بعد 5 ثواني
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // تحميل الحالة عند البدء
        loadStateFromStorage();
    </script>
</body>
</html>
