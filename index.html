<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Verification Dashboard v2.0</title>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #ff0054;
            --info: #4895ef;
            --dark: #212529;
            --light: #f8f9fa;
            --border: #dee2e6;
            --text-gray: #6c757d;
            --sidebar-width: 260px;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        body.locked {
            overflow: hidden;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--dark) 0%, #343a40 100%);
            color: white;
            padding: 25px 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(45deg, #4cc9f0, #4361ee);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: rgba(255,255,255,0.8);
            font-weight: 500;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .agent-profile {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .agent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* Header */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left h1 {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--dark), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 5px;
        }

        .session-info {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .session-badge {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            border-left: 5px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: white;
        }

        .stat-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-gray);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-change {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .change-positive { color: var(--success); }
        .change-negative { color: var(--danger); }

        /* Charts */
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            height: 350px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Filters Bar */
        .filters-bar {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-label {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .filter-select {
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        /* Table */
        .table-wrapper {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .table-header {
            padding: 25px;
            background: linear-gradient(90deg, #f8f9fa, #e9ecef);
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 18px 20px;
            text-align: left;
            font-weight: 700;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
            user-select: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        th:hover {
            background: #e9ecef;
        }

        th i {
            margin-left: 8px;
            opacity: 0.5;
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr {
            transition: all 0.2s;
        }

        tr:hover {
            background: #f8f9fa;
            transform: scale(1.002);
        }

        tr.late {
            background: linear-gradient(90deg, rgba(255, 0, 84, 0.05) 0%, transparent 100%);
            border-left: 4px solid var(--danger);
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending { background: rgba(251, 191, 36, 0.15); color: #d97706; }
        .status-delivered { background: rgba(76, 201, 240, 0.15); color: #0891b2; }
        .status-delayed { background: rgba(247, 37, 133, 0.15); color: #be185d; }
        .status-cancelled { background: rgba(108, 117, 125, 0.15); color: var(--text-gray); }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            color: white;
        }

        .btn-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-edit { background: var(--info); }
        .btn-cancel { background: var(--danger); }
        .btn-save { background: var(--success); }
        .btn-refresh { background: var(--warning); }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #38b000);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--danger), #d00000);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .modal-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .modal-icon.success { background: var(--success); }
        .modal-icon.warning { background: var(--warning); }
        .modal-icon.danger { background: var(--danger); }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-gray);
        }

        .empty-state i {
            font-size: 5rem;
            margin-bottom: 20px;
            color: #e9ecef;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            transform: translateX(100%);
            opacity: 0;
            animation: slideInRight 0.3s ease forwards;
            border-left: 4px solid var(--primary);
        }

        @keyframes slideInRight {
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-left-color: var(--success); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.danger { border-left-color: var(--danger); }

        .toast-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
        }

        .toast.success .toast-icon { background: var(--success); }
        .toast.warning .toast-icon { background: var(--warning); }
        .toast.danger .toast-icon { background: var(--danger); }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 4000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .table-wrapper {
                overflow-x: auto;
            }
        }

        /* Toggle Button */
        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }

        @media (max-width: 768px) {
            .sidebar-toggle {
                display: flex;
            }
        }
    </style>
</head>
<body class="locked">
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal" style="display: flex;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon success">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div>
                    <h2 style="margin: 0;">Agent Authentication</h2>
                    <p style="color: var(--text-gray); margin: 5px 0 0;">Enter credentials to access dashboard</p>
                </div>
            </div>
            
            <div style="margin: 30px 0;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark);">Agent Name</label>
                    <input type="text" id="agentNameInput" class="filter-select" placeholder="Enter your full name" style="width: 100%;" autofocus>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark);">Shift Code</label>
                    <input type="password" id="shiftCodeInput" class="filter-select" placeholder="Enter shift access code" style="width: 100%;">
                    <small style="color: var(--text-gray); display: block; margin-top: 5px;">Default: OPERATIONS2024</small>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="loginAgent()">
                    <i class="fas fa-sign-in-alt"></i> Start Shift
                </button>
                <button class="btn btn-outline" style="flex: 1;" onclick="demoLogin()">
                    <i class="fas fa-magic"></i> Demo Mode
                </button>
            </div>
        </div>
    </div>

    <!-- Cancellation Modal -->
    <div class="modal-overlay" id="cancelModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div>
                    <h2 style="margin: 0;">Cancel Order</h2>
                    <p style="color: var(--text-gray); margin: 5px 0 0;">Confirm cancellation details</p>
                </div>
            </div>
            
            <div style="margin: 25px 0;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark);">Cancellation Reason</label>
                    <select id="cancelReason" class="filter-select" style="width: 100%;">
                        <option value="">-- Select Reason --</option>
                        <option value="Customer refused">Customer refused order</option>
                        <option value="Out of stock">Out of stock</option>
                        <option value="Duplicate order">Duplicate order</option>
                        <option value="Wrong address">Wrong address provided</option>
                        <option value="Payment failed">Payment failed</option>
                        <option value="Delivery unavailable">Delivery unavailable</option>
                        <option value="System error">System error</option>
                        <option value="Other">Other (specify below)</option>
                    </select>
                </div>
                
                <div id="otherReasonContainer" style="display: none; margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark);">Specify Reason</label>
                    <input type="text" id="otherReason" class="filter-select" placeholder="Enter cancellation reason" style="width: 100%;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark);">Additional Notes</label>
                    <textarea id="cancelNotes" class="filter-select" placeholder="Optional additional notes" style="width: 100%; height: 80px; resize: vertical;"></textarea>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-outline" onclick="closeCancelModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmCancellation()">
                    <i class="fas fa-ban"></i> Confirm Cancellation
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div class="modal-overlay" id="summaryModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon success">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div>
                    <h2 style="margin: 0;">Shift Summary</h2>
                    <p style="color: var(--text-gray); margin: 5px 0 0;">Add notes for the next shift</p>
                </div>
            </div>
            
            <div style="margin: 25px 0;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark);">Shift Summary</label>
                    <textarea id="summaryInput" class="filter-select" placeholder="e.g., All orders verified. Special instructions for next shift. System updates completed." style="width: 100%; height: 150px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark);">Priority Level</label>
                    <select id="summaryPriority" class="filter-select" style="width: 100%;">
                        <option value="normal">Normal Priority</option>
                        <option value="high">High Priority</option>
                        <option value="urgent">Urgent Attention Required</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-outline" onclick="closeSummaryModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveSummary()">
                    <i class="fas fa-save"></i> Save Summary
                </button>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar Toggle -->
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-chart-network" style="font-size: 1.8rem; color: #4cc9f0;"></i>
                <h2>Ops Dashboard</h2>
            </div>
            
            <div class="nav-list">
                <div class="nav-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="showSection('orders')">
                    <i class="fas fa-boxes"></i>
                    <span>Order Management</span>
                </div>
                <div class="nav-item" onclick="showSection('analytics')">
                    <i class="fas fa-chart-pie"></i>
                    <span>Analytics</span>
                </div>
                <div class="nav-item" onclick="openSummaryModal()">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Shift Summary</span>
                </div>
                <div class="nav-item" onclick="showSection('reports')">
                    <i class="fas fa-file-export"></i>
                    <span>Reports</span>
                </div>
                <div class="nav-item" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
            </div>
            
            <div class="agent-profile">
                <div class="agent-avatar" id="agentAvatar">SC</div>
                <div>
                    <div style="font-weight: 600;" id="sidebarAgentName">Not Logged In</div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);" id="sidebarRole">Operator</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Header -->
            <div class="main-header">
                <div class="header-left">
                    <h1>Operations Management Dashboard</h1>
                    <div class="session-info">
                        <span class="session-badge" id="sessionTime">Session: 0h 0m</span>
                        <span class="session-badge" id="updatesCount">Updates: 0</span>
                        <span class="session-badge" id="ordersCount">Orders: 0</span>
                    </div>
                </div>
                
                <div class="header-actions">
                    <div class="quick-actions">
                        <input type="file" id="excelInput" accept=".xlsx, .xls" style="display: none;" onchange="handleFileUpload(event)">
                        
                        <button class="btn btn-outline" onclick="downloadTemplate()">
                            <i class="fas fa-file-download"></i> Download Template
                        </button>
                        
                        <button class="btn btn-primary" onclick="document.getElementById('excelInput').click()">
                            <i class="fas fa-file-upload"></i> Import Excel
                        </button>
                        
                        <button class="btn btn-success" onclick="exportExcel()" id="btnExport" style="display: none;">
                            <i class="fas fa-file-export"></i> Export Report
                        </button>
                        
                        <button class="btn btn-danger" onclick="logoutAgent()">
                            <i class="fas fa-sign-out-alt"></i> End Shift
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary Alert -->
            <div class="filters-bar" id="summaryAlert" style="display: none;">
                <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                    <i class="fas fa-info-circle" style="color: var(--info); font-size: 1.2rem;"></i>
                    <div>
                        <strong style="color: var(--dark);">Previous Shift Summary:</strong>
                        <span id="previousSummaryText" style="color: var(--text-gray); margin-left: 10px;">No summary found</span>
                    </div>
                </div>
                <button class="btn btn-outline" style="padding: 8px 16px;" onclick="dismissSummary()">
                    <i class="fas fa-times"></i> Dismiss
                </button>
            </div>

            <!-- Filters -->
            <div class="filters-bar" id="filtersBar" style="display: none;">
                <div class="filter-group">
                    <span class="filter-label">Status:</span>
                    <select class="filter-select" id="filterStatus" onchange="applyFilters()">
                        <option value="all">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Delivered">Delivered</option>
                        <option value="Delayed">Delayed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <span class="filter-label">Branch:</span>
                    <select class="filter-select" id="filterBranch" onchange="applyFilters()">
                        <option value="all">All Branches</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <span class="filter-label">Sort by:</span>
                    <select class="filter-select" id="sortBy" onchange="applySorting()">
                        <option value="date_desc">Date (Newest)</option>
                        <option value="date_asc">Date (Oldest)</option>
                        <option value="total_desc">Amount (High to Low)</option>
                        <option value="total_asc">Amount (Low to High)</option>
                        <option value="status">Status</option>
                    </select>
                </div>
                
                <div class="filter-group" style="margin-left: auto;">
                    <input type="text" class="filter-select" id="searchInput" placeholder="Search orders..." style="min-width: 200px;" onkeyup="applySearch()">
                    <button class="btn-icon btn-refresh" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent" style="display: none;">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(45deg, var(--primary), var(--secondary));">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <div class="stat-label">Total Orders</div>
                        <div class="stat-value" id="kpiTotal">0</div>
                        <div class="stat-change" id="kpiTotalChange">--</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(45deg, var(--success), #38b000);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-label">Delivered</div>
                        <div class="stat-value" id="kpiDelivered">0</div>
                        <div class="stat-change" id="kpiDeliveredChange">--</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(45deg, var(--warning), #e63946);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-label">Delayed</div>
                        <div class="stat-value" id="kpiDelayed">0</div>
                        <div class="stat-change change-negative" id="kpiDelayedChange">--</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(45deg, var(--danger), #d00000);">
                            <i class="fas fa-ban"></i>
                        </div>
                        <div class="stat-label">Cancelled</div>
                        <div class="stat-value" id="kpiCancelled">0</div>
                        <div class="stat-change change-negative" id="kpiCancelledChange">--</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(45deg, #7209b7, #b5179e);">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-label">Total Revenue</div>
                        <div class="stat-value" id="kpiRevenue">$0</div>
                        <div class="stat-change" id="kpiRevenueChange">--</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(45deg, #4895ef, #4361ee);">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-label">Success Rate</div>
                        <div class="stat-value" id="kpiSuccessRate">0%</div>
                        <div class="stat-change" id="kpiSuccessRateChange">--</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-container">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 style="margin: 0;">Order Status Distribution</h3>
                            <select class="filter-select" id="chartType" style="width: auto;" onchange="updateChartType()">
                                <option value="doughnut">Doughnut</option>
                                <option value="pie">Pie</option>
                                <option value="bar">Bar</option>
                            </select>
                        </div>
                        <canvas id="statusChart"></canvas>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 style="margin: 0;">Performance Trends</h3>
                            <select class="filter-select" id="trendPeriod" style="width: auto;" onchange="updateTrendChart()">
                                <option value="daily">Daily</option>
                                <option value="hourly">Hourly</option>
                            </select>
                        </div>
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-wrapper">
                    <div class="table-header">
                        <h3 style="margin: 0;">Order Management</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="color: var(--text-gray); font-size: 0.9rem;" id="tableInfo">Showing 0 orders</span>
                            <button class="btn-icon btn-refresh" onclick="refreshDashboard()">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table id="orderTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable('id')">ID <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('customer')">Customer <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('date')">Order Date <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('total')">Amount <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('branch')">Branch <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('status')">Status <i class="fas fa-sort"></i></th>
                                    <th>Reason</th>
                                    <th onclick="sortTable('updatedBy')">Updated By <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable('updatedAt')">Last Update <i class="fas fa-sort"></i></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>No Data Loaded</h3>
                <p>Upload an Excel file or use demo data to get started</p>
                <div style="margin-top: 25px; display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="document.getElementById('excelInput').click()">
                        <i class="fas fa-upload"></i> Upload Excel
                    </button>
                    <button class="btn btn-outline" onclick="loadDemoData()">
                        <i class="fas fa-magic"></i> Load Demo Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= ENHANCED CONFIGURATION =================
        const CONFIG = {
            DELAY_THRESHOLD_MINUTES: 45,
            SESSION_TIMEOUT: 7200, // 2 hours in seconds
            AUTO_SAVE_INTERVAL: 30000, // 30 seconds
            SHIFT_CODE: "OPERATIONS2024",
            DEMO_DATA_SIZE: 50
        };

        // ================= GLOBAL STATE =================
        let state = {
            currentUser: '',
            sessionStart: null,
            updatesMade: 0,
            globalData: [],
            filteredData: [],
            editingOrderId: null,
            charts: {},
            summary: '',
            previousSummary: '',
            sessionTimer: null,
            autoSaveTimer: null,
            sortConfig: { field: 'date', direction: 'desc' },
            filters: {
                status: 'all',
                branch: 'all',
                search: ''
            }
        };

        // ================= ENHANCED INITIALIZATION =================
        document.addEventListener('DOMContentLoaded', function() {
            initSession();
            setupEventListeners();
            checkSessionTimeout();
            
            // Auto-save every 30 seconds
            state.autoSaveTimer = setInterval(autoSaveState, CONFIG.AUTO_SAVE_INTERVAL);
            
            // Update session timer every minute
            state.sessionTimer = setInterval(updateSessionTime, 60000);
        });

        function initSession() {
            const savedState = localStorage.getItem('ops_dashboard_state');
            const storedUser = localStorage.getItem('ops_dashboard_user');
            
            if (storedUser) {
                state.currentUser = storedUser;
                
                if (savedState) {
                    try {
                        const parsed = JSON.parse(savedState);
                        state.globalData = parsed.data || [];
                        state.summary = parsed.summary || '';
                        state.updatesMade = parsed.updatesMade || 0;
                        state.sessionStart = new Date(parsed.sessionStart);
                    } catch (e) {
                        console.warn('Failed to restore session state');
                    }
                }
                
                unlockDashboard();
                
                if (state.globalData.length > 0) {
                    initDashboard();
                }
            } else {
                document.getElementById('loginModal').style.display = 'flex';
            }
        }

        function setupEventListeners() {
            // Enter key in login
            document.getElementById('agentNameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') loginAgent();
            });
            
            document.getElementById('shiftCodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') loginAgent();
            });

            // Cancel reason change
            document.getElementById('cancelReason').addEventListener('change', function() {
                const otherContainer = document.getElementById('otherReasonContainer');
                otherContainer.style.display = this.value === 'Other' ? 'block' : 'none';
            });

            // Auto-save listeners
            ['summaryInput', 'cancelNotes', 'otherReason'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', function() {
                        state.summary = document.getElementById('summaryInput')?.value || '';
                        saveState();
                    });
                }
            });

            // Prevent navigation on unsaved changes
            window.addEventListener('beforeunload', function(e) {
                if (state.updatesMade > 0 || state.summary) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                }
            });

            // Responsive sidebar
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    document.getElementById('sidebar').classList.remove('show');
                }
            });
        }

        // ================= ENHANCED AUTHENTICATION =================
        function loginAgent() {
            const name = document.getElementById('agentNameInput').value.trim();
            const code = document.getElementById('shiftCodeInput').value.trim();
            
            if (!name) {
                showToast('Please enter your name', 'warning');
                return;
            }
            
            if (code !== CONFIG.SHIFT_CODE) {
                showToast('Invalid shift access code', 'danger');
                return;
            }
            
            state.currentUser = name;
            state.sessionStart = new Date();
            state.updatesMade = 0;
            
            localStorage.setItem('ops_dashboard_user', name);
            saveState();
            
            showToast(`Welcome, ${name}! Shift started successfully.`, 'success');
            unlockDashboard();
            
            // Update avatar
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('agentAvatar').textContent = initials;
        }

        function demoLogin() {
            state.currentUser = "Demo Agent";
            state.sessionStart = new Date();
            state.updatesMade = 0;
            
            localStorage.setItem('ops_dashboard_user', state.currentUser);
            
            // Generate demo data
            loadDemoData();
            
            showToast('Demo mode activated with sample data', 'success');
            unlockDashboard();
            
            document.getElementById('agentAvatar').textContent = 'DA';
        }

        function unlockDashboard() {
            document.body.classList.remove('locked');
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('sidebarAgentName').textContent = state.currentUser;
            
            if (state.globalData.length > 0) {
                initDashboard();
            }
        }

        function logoutAgent() {
            if (confirm('End your shift and log out?')) {
                if (state.updatesMade > 0 || state.summary) {
                    if (confirm('You have unsaved changes. Export before logging out?')) {
                        exportExcel();
                    }
                }
                
                localStorage.removeItem('ops_dashboard_user');
                localStorage.removeItem('ops_dashboard_state');
                clearInterval(state.sessionTimer);
                clearInterval(state.autoSaveTimer);
                
                showToast('Shift ended successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            }
        }

        // ================= ENHANCED FILE HANDLING =================
        function downloadTemplate() {
            const templateData = [
                {
                    "Order ID": "ORD-1001",
                    "Customer": "John Smith",
                    "Order Date": new Date().toISOString(),
                    "Total": 150.00,
                    "Branch": "Downtown",
                    "Status": "Pending",
                    "Reason": "",
                    "Updated By": "",
                    "Updated At": ""
                },
                {
                    "Order ID": "ORD-1002",
                    "Customer": "Emma Wilson",
                    "Order Date": new Date(Date.now() - 3600000).toISOString(),
                    "Total": 89.99,
                    "Branch": "Uptown",
                    "Status": "Delivered",
                    "Reason": "Delivered on time",
                    "Updated By": "Agent 1",
                    "Updated At": new Date().toISOString()
                }
            ];
            
            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Orders");
            
            // Add instructions sheet
            const instructions = [
                ["COLUMN", "DESCRIPTION", "REQUIRED", "EXAMPLE"],
                ["Order ID", "Unique order identifier", "Yes", "ORD-1001"],
                ["Customer", "Customer full name", "Yes", "John Smith"],
                ["Order Date", "Date and time of order", "Yes", "2024-01-15T10:30:00Z"],
                ["Total", "Order amount", "Yes", "150.00"],
                ["Branch", "Branch location", "No", "Downtown"],
                ["Status", "Order status", "No", "Pending"],
                ["Reason", "Status reason/notes", "No", "Customer requested"],
                ["Updated By", "Last agent name", "No", "Agent 1"],
                ["Updated At", "Last update timestamp", "No", "2024-01-15T11:30:00Z"]
            ];
            
            const wsInstructions = XLSX.utils.aoa_to_sheet(instructions);
            XLSX.utils.book_append_sheet(wb, wsInstructions, "Instructions");
            
            XLSX.writeFile(wb, "Ops_Dashboard_Template.xlsx");
        }

        function handleFileUpload(event) {
            showLoading();
            
            const file = event.target.files[0];
            if (!file) {
                hideLoading();
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Process orders
                    let jsonOrders = [];
                    workbook.SheetNames.forEach(sheetName => {
                        if (sheetName.toLowerCase().includes('order')) {
                            const sheet = workbook.Sheets[sheetName];
                            jsonOrders = XLSX.utils.sheet_to_json(sheet);
                        }
                    });
                    
                    if (jsonOrders.length === 0 && workbook.SheetNames.length > 0) {
                        jsonOrders = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    }

                    // Process summary
                    state.previousSummary = '';
                    workbook.SheetNames.forEach(sheetName => {
                        if (sheetName.toLowerCase().includes('summary')) {
                            const sheet = workbook.Sheets[sheetName];
                            const jsonSummary = XLSX.utils.sheet_to_json(sheet);
                            if (jsonSummary.length > 0) {
                                const last = jsonSummary[jsonSummary.length - 1];
                                state.previousSummary = `${last.Summary || ''} (By: ${last.Manager || 'Unknown'})`;
                            }
                        }
                    });

                    // Normalize data
                    state.globalData = jsonOrders.map(row => {
                        const getVal = (keys, defaultValue = '') => {
                            for (let key of keys) {
                                if (row[key] !== undefined && row[key] !== null && row[key] !== '') {
                                    return row[key];
                                }
                            }
                            return defaultValue;
                        };

                        let dateValue = getVal(['Order Date', 'Date', 'Time', 'Timestamp']);
                        if (typeof dateValue === 'number') {
                            dateValue = XLSX.SSF.parse_date_code(dateValue);
                        }

                        return {
                            id: getVal(['Order ID', 'Order no', 'id', 'ID']),
                            customer: getVal(['Customer', 'Cus. Name', 'Client', 'Customer Name']),
                            date: dateValue || new Date().toISOString(),
                            total: parseFloat(getVal(['Total', 'Amount', 'Order Total', 'Price'], 0)) || 0,
                            branch: getVal(['Branch', 'Outlet', 'Location'], 'Unknown'),
                            status: getVal(['Status', 'status', 'Order Status'], 'Pending'),
                            reason: getVal(['Reason', 'Notes', 'Comment', 'Remarks'], ''),
                            updatedBy: getVal(['Updated By', 'Agent', 'Modified By'], ''),
                            updatedAt: getVal(['Updated At', 'Timestamp', 'Last Updated'], ''),
                            _originalIndex: state.globalData.length
                        };
                    }).filter(row => row.id && row.id.toString().trim() !== '');

                    // Show summary alert if exists
                    if (state.previousSummary) {
                        document.getElementById('previousSummaryText').textContent = state.previousSummary;
                        document.getElementById('summaryAlert').style.display = 'flex';
                    }

                    hideLoading();
                    
                    if (state.globalData.length > 0) {
                        showToast(`Successfully loaded ${state.globalData.length} orders`, 'success');
                        initDashboard();
                    } else {
                        showToast('No valid orders found in file', 'warning');
                    }
                    
                    saveState();
                } catch (error) {
                    hideLoading();
                    showToast('Error processing file: ' + error.message, 'danger');
                    console.error(error);
                }
            };
            
            reader.onerror = function() {
                hideLoading();
                showToast('Error reading file', 'danger');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function loadDemoData() {
            showLoading();
            
            // Generate realistic demo data
            const branches = ['Downtown', 'Uptown', 'Westside', 'East End', 'Central'];
            const customers = ['John Smith', 'Emma Wilson', 'Michael Brown', 'Sarah Johnson', 'David Lee', 
                              'Lisa Taylor', 'Robert Wang', 'Maria Garcia', 'James Miller', 'Patricia Davis'];
            const statuses = ['Pending', 'Delivered', 'Delayed', 'Cancelled'];
            
            const demoData = [];
            const now = new Date();
            
            for (let i = 1; i <= CONFIG.DEMO_DATA_SIZE; i++) {
                const hoursAgo = Math.floor(Math.random() * 72);
                const orderDate = new Date(now.getTime() - hoursAgo * 3600000);
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const isDelivered = status === 'Delivered';
                const isCancelled = status === 'Cancelled';
                
                demoData.push({
                    id: `ORD-${1000 + i}`,
                    customer: customers[Math.floor(Math.random() * customers.length)],
                    date: orderDate.toISOString(),
                    total: parseFloat((Math.random() * 500 + 20).toFixed(2)),
                    branch: branches[Math.floor(Math.random() * branches.length)],
                    status: status,
                    reason: isDelivered ? 'Delivered successfully' : 
                           isCancelled ? ['Customer refused', 'Out of stock', 'Wrong address'][Math.floor(Math.random() * 3)] : '',
                    updatedBy: isDelivered || isCancelled ? 'Demo Agent' : '',
                    updatedAt: isDelivered || isCancelled ? 
                              new Date(orderDate.getTime() + Math.random() * 3600000).toISOString() : '',
                    _originalIndex: i
                });
            }
            
            state.globalData = demoData;
            state.previousSummary = "Demo data loaded. This is sample data for testing purposes.";
            
            hideLoading();
            showToast(`Demo data loaded with ${state.globalData.length} orders`, 'success');
            initDashboard();
            saveState();
        }

        // ================= ENHANCED DASHBOARD =================
        function initDashboard() {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
            document.getElementById('filtersBar').style.display = 'flex';
            document.getElementById('btnExport').style.display = 'inline-flex';
            
            // Populate branch filter
            populateBranchFilter();
            
            // Calculate initial stats
            calculateStats();
            
            // Initial render
            applyFilters();
            
            // Update session display
            updateSessionTime();
            updateOrdersCount();
        }

        function populateBranchFilter() {
            const branchSelect = document.getElementById('filterBranch');
            const branches = [...new Set(state.globalData.map(o => o.branch).filter(b => b))];
            
            branchSelect.innerHTML = '<option value="all">All Branches</option>';
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branch;
                branchSelect.appendChild(option);
            });
        }

        function calculateStats() {
            const total = state.globalData.length;
            const delivered = state.globalData.filter(o => o.status === 'Delivered').length;
            const cancelled = state.globalData.filter(o => o.status === 'Cancelled').length;
            
            let delayedCount = 0;
            const now = new Date();
            
            state.globalData.forEach(o => {
                if (o.status === 'Delivered' || o.status === 'Cancelled') return;
                
                try {
                    const orderDate = new Date(o.date);
                    if (!isNaN(orderDate.getTime())) {
                        const minutesDiff = (now - orderDate) / 60000;
                        if (minutesDiff > CONFIG.DELAY_THRESHOLD_MINUTES) {
                            delayedCount++;
                            o._isLate = true;
                        } else {
                            o._isLate = false;
                        }
                    }
                } catch (e) {
                    o._isLate = false;
                }
            });

            const totalRevenue = state.globalData.reduce((sum, o) => sum + o.total, 0);
            const deliveredRevenue = state.globalData
                .filter(o => o.status === 'Delivered')
                .reduce((sum, o) => sum + o.total, 0);
            
            const successRate = total > 0 ? Math.round((delivered / total) * 100) : 0;

            // Update KPI displays
            document.getElementById('kpiTotal').textContent = total;
            document.getElementById('kpiDelivered').textContent = delivered;
            document.getElementById('kpiDelayed').textContent = delayedCount;
            document.getElementById('kpiCancelled').textContent = cancelled;
            document.getElementById('kpiRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('kpiSuccessRate').textContent = `${successRate}%`;

            // Calculate changes (demo - in real app, compare with previous period)
            document.getElementById('kpiTotalChange').textContent = ' 12% this week';
            document.getElementById('kpiDeliveredChange').textContent = ' 8% this week';
            document.getElementById('kpiDelayedChange').textContent = ' 3% this week';
            document.getElementById('kpiCancelledChange').textContent = ' 5% this week';
            document.getElementById('kpiRevenueChange').textContent = ' 15% this week';
            document.getElementById('kpiSuccessRateChange').textContent = ' 4% this week';
        }

        function applyFilters() {
            state.filters.status = document.getElementById('filterStatus').value;
            state.filters.branch = document.getElementById('filterBranch').value;
            state.filters.search = document.getElementById('searchInput').value.toLowerCase();
            
            state.filteredData = state.globalData.filter(order => {
                // Status filter
                if (state.filters.status !== 'all' && order.status !== state.filters.status) {
                    return false;
                }
                
                // Branch filter
                if (state.filters.branch !== 'all' && order.branch !== state.filters.branch) {
                    return false;
                }
                
                // Search filter
                if (state.filters.search) {
                    const searchStr = state.filters.search;
                    return (
                        order.id.toLowerCase().includes(searchStr) ||
                        order.customer.toLowerCase().includes(searchStr) ||
                        order.reason.toLowerCase().includes(searchStr)
                    );
                }
                
                return true;
            });

            applySorting();
        }

        function applySorting() {
            const sortValue = document.getElementById('sortBy').value;
            let field, direction;
            
            switch (sortValue) {
                case 'date_desc':
                    field = 'date';
                    direction = 'desc';
                    break;
                case 'date_asc':
                    field = 'date';
                    direction = 'asc';
                    break;
                case 'total_desc':
                    field = 'total';
                    direction = 'desc';
                    break;
                case 'total_asc':
                    field = 'total';
                    direction = 'asc';
                    break;
                case 'status':
                    field = 'status';
                    direction = 'asc';
                    break;
                default:
                    field = 'date';
                    direction = 'desc';
            }
            
            state.sortConfig = { field, direction };
            sortTable(field);
        }

        function sortTable(field) {
            // Toggle direction if clicking same field
            if (state.sortConfig.field === field) {
                state.sortConfig.direction = state.sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortConfig.field = field;
                state.sortConfig.direction = 'asc';
            }
            
            state.filteredData.sort((a, b) => {
                let aValue = a[field];
                let bValue = b[field];
                
                // Handle dates
                if (field === 'date' || field === 'updatedAt') {
                    aValue = new Date(aValue).getTime();
                    bValue = new Date(bValue).getTime();
                }
                
                // Handle strings
                if (typeof aValue === 'string') {
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }
                
                if (aValue < bValue) {
                    return state.sortConfig.direction === 'asc' ? -1 : 1;
                }
                if (aValue > bValue) {
                    return state.sortConfig.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
            
            renderTable();
        }

        function applySearch() {
            applyFilters();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            document.getElementById('tableInfo').textContent = 
                `Showing ${state.filteredData.length} of ${state.globalData.length} orders`;
            
            if (state.filteredData.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="10" style="text-align: center; padding: 40px; color: var(--text-gray);">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        <div>No orders match your filters</div>
                    </td>
                `;
                tbody.appendChild(tr);
                return;
            }
            
            state.filteredData.forEach((order) => {
                const tr = document.createElement('tr');
                if (order._isLate && order.status !== 'Delivered' && order.status !== 'Cancelled') {
                    tr.classList.add('late');
                }
                
                // Format date
                let dateStr = 'Invalid Date';
                try {
                    const date = new Date(order.date);
                    dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                } catch (e) {
                    dateStr = order.date;
                }
                
                // Format last update
                let updatedStr = '-';
                if (order.updatedAt) {
                    try {
                        const updated = new Date(order.updatedAt);
                        updatedStr = updated.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    } catch (e) {
                        updatedStr = order.updatedAt;
                    }
                }
                
                tr.innerHTML = `
                    <td><strong>${order.id}</strong></td>
                    <td>${order.customer}</td>
                    <td>${dateStr}</td>
                    <td>$${order.total.toFixed(2)}</td>
                    <td><span class="agent-pill">${order.branch}</span></td>
                    <td>
                        <select class="status-badge status-${order.status.toLowerCase()}" 
                                onchange="handleStatusChange('${order.id}', this.value)"
                                style="border: none; padding: 6px 10px; cursor: pointer; font-weight: 600;">
                            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="Delayed" ${order.status === 'Delayed' ? 'selected' : ''}>Delayed</option>
                            <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td style="max-width: 200px; font-size: 0.85rem;">${order.reason || '-'}</td>
                    <td><span class="agent-pill">${order.updatedBy || '-'}</span></td>
                    <td style="font-size: 0.85rem; color: var(--text-gray);">${updatedStr}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-edit" onclick="editOrder('${order.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon btn-cancel" onclick="confirmCancelOrder('${order.id}')">
                                <i class="fas fa-ban"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            updateCharts();
        }

        // ================= ENHANCED ORDER MANAGEMENT =================
        function handleStatusChange(id, newStatus) {
            const orderIndex = state.globalData.findIndex(o => o.id === id);
            if (orderIndex === -1) return;
            
            const order = state.globalData[orderIndex];
            
            if (newStatus === 'Cancelled') {
                if (!order.reason) {
                    state.editingOrderId = id;
                    document.getElementById('cancelModal').style.display = 'flex';
                    return;
                }
            }
            
            updateOrderStatus(id, newStatus, order.reason);
        }

        function confirmCancelOrder(id) {
            state.editingOrderId = id;
            document.getElementById('cancelModal').style.display = 'flex';
        }

        function closeCancelModal() {
            document.getElementById('cancelModal').style.display = 'none';
            document.getElementById('cancelReason').value = '';
            document.getElementById('otherReason').value = '';
            document.getElementById('otherReasonContainer').style.display = 'none';
            document.getElementById('cancelNotes').value = '';
            state.editingOrderId = null;
        }

        function confirmCancellation() {
            const reason = document.getElementById('cancelReason').value;
            const otherReason = document.getElementById('otherReason').value;
            const notes = document.getElementById('cancelNotes').value;
            
            if (!reason) {
                showToast('Please select a cancellation reason', 'warning');
                return;
            }
            
            const finalReason = reason === 'Other' ? otherReason : reason;
            if (!finalReason) {
                showToast('Please specify the cancellation reason', 'warning');
                return;
            }
            
            const fullReason = notes ? `${finalReason} (${notes})` : finalReason;
            updateOrderStatus(state.editingOrderId, 'Cancelled', fullReason);
            
            closeCancelModal();
            showToast(`Order ${state.editingOrderId} cancelled`, 'success');
        }

        function updateOrderStatus(id, status, reason = '') {
            const orderIndex = state.globalData.findIndex(o => o.id === id);
            if (orderIndex === -1) return;
            
            state.globalData[orderIndex].status = status;
            state.globalData[orderIndex].reason = reason;
            state.globalData[orderIndex].updatedBy = state.currentUser;
            state.globalData[orderIndex].updatedAt = new Date().toISOString();
            
            state.updatesMade++;
            updateSessionDisplay();
            
            applyFilters();
            saveState();
        }

        function editOrder(id) {
            // In a real app, this would open an edit modal
            showToast(`Edit functionality for order ${id} would open here`, 'info');
        }

        // ================= ENHANCED SUMMARY SYSTEM =================
        function openSummaryModal() {
            document.getElementById('summaryInput').value = state.summary;
            document.getElementById('summaryModal').style.display = 'flex';
        }

        function closeSummaryModal() {
            document.getElementById('summaryModal').style.display = 'none';
        }

        function saveSummary() {
            const note = document.getElementById('summaryInput').value.trim();
            const priority = document.getElementById('summaryPriority').value;
            
            if (!note) {
                showToast('Please enter a summary note', 'warning');
                return;
            }
            
            state.summary = `[${priority.toUpperCase()}] ${note}`;
            closeSummaryModal();
            
            showToast('Summary saved successfully', 'success');
            saveState();
        }

        function dismissSummary() {
            document.getElementById('summaryAlert').style.display = 'none';
        }

        // ================= ENHANCED EXPORT SYSTEM =================
        function exportExcel() {
            showLoading();
            
            try {
                // Prepare orders data
                const exportData = state.globalData.map(o => ({
                    "Order ID": o.id,
                    "Customer": o.customer,
                    "Order Date": o.date,
                    "Total": o.total,
                    "Branch": o.branch,
                    "Status": o.status,
                    "Reason": o.reason,
                    "Updated By": o.updatedBy,
                    "Updated At": o.updatedAt,
                    "Agent Notes": o._notes || ''
                }));
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Orders");
                
                // Add summary sheet
                if (state.summary) {
                    const summaryData = [{
                        "Manager": state.currentUser,
                        "Date": new Date().toISOString(),
                        "Summary": state.summary,
                        "Total Orders": state.globalData.length,
                        "Delivered": state.globalData.filter(o => o.status === 'Delivered').length,
                        "Cancelled": state.globalData.filter(o => o.status === 'Cancelled').length,
                        "Session Duration": formatDuration(new Date() - state.sessionStart)
                    }];
                    
                    const wsSummary = XLSX.utils.json_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, wsSummary, "Shift_Summary");
                }
                
                // Add audit log
                const auditData = state.globalData
                    .filter(o => o.updatedBy)
                    .map(o => ({
                        "Order ID": o.id,
                        "Action": `Status changed to ${o.status}`,
                        "Agent": o.updatedBy,
                        "Timestamp": o.updatedAt,
                        "Reason": o.reason
                    }));
                
                if (auditData.length > 0) {
                    const wsAudit = XLSX.utils.json_to_sheet(auditData);
                    XLSX.utils.book_append_sheet(wb, wsAudit, "Audit_Log");
                }
                
                // Generate filename
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                const filename = `Ops_Report_${state.currentUser.replace(/\s+/g, '_')}_${timestamp}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                hideLoading();
                showToast(`Report exported: ${filename}`, 'success');
            } catch (error) {
                hideLoading();
                showToast('Error exporting file: ' + error.message, 'danger');
                console.error(error);
            }
        }

        // ================= ENHANCED VISUALIZATION =================
        function updateCharts() {
            updateStatusChart();
            updateTrendChart();
        }

        function updateStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            const chartType = document.getElementById('chartType').value;
            
            const statusCounts = {
                Pending: 0,
                Delivered: 0,
                Delayed: 0,
                Cancelled: 0
            };
            
            state.filteredData.forEach(o => {
                if (statusCounts[o.status] !== undefined) {
                    statusCounts[o.status]++;
                }
            });
            
            if (state.charts.status) {
                state.charts.status.destroy();
            }
            
            state.charts.status = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            'rgba(251, 191, 36, 0.8)',
                            'rgba(76, 201, 240, 0.8)',
                            'rgba(247, 37, 133, 0.8)',
                            'rgba(108, 117, 125, 0.8)'
                        ],
                        borderColor: [
                            'rgb(251, 191, 36)',
                            'rgb(76, 201, 240)',
                            'rgb(247, 37, 133)',
                            'rgb(108, 117, 125)'
                        ],
                        borderWidth: 1,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const period = document.getElementById('trendPeriod').value;
            
            // Generate sample trend data
            const labels = period === 'hourly' 
                ? Array.from({length: 12}, (_, i) => `${9 + i}:00`)
                : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            const deliveredData = labels.map(() => Math.floor(Math.random() * 20) + 10);
            const delayedData = labels.map(() => Math.floor(Math.random() * 5) + 1);
            
            if (state.charts.trend) {
                state.charts.trend.destroy();
            }
            
            state.charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Delivered',
                            data: deliveredData,
                            borderColor: 'rgb(76, 201, 240)',
                            backgroundColor: 'rgba(76, 201, 240, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Delayed',
                            data: delayedData,
                            borderColor: 'rgb(247, 37, 133)',
                            backgroundColor: 'rgba(247, 37, 133, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Orders'
                            }
                        }
                    }
                }
            });
        }

        function updateChartType() {
            updateStatusChart();
        }

        // ================= ENHANCED UTILITIES =================
        function updateSessionTime() {
            if (!state.sessionStart) return;
            
            const now = new Date();
            const diff = now - state.sessionStart;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            
            document.getElementById('sessionTime').textContent = 
                `Session: ${hours}h ${minutes}m`;
        }

        function updateSessionDisplay() {
            document.getElementById('updatesCount').textContent = 
                `Updates: ${state.updatesMade}`;
        }

        function updateOrdersCount() {
            document.getElementById('ordersCount').textContent = 
                `Orders: ${state.globalData.length}`;
        }

        function refreshDashboard() {
            calculateStats();
            applyFilters();
            showToast('Dashboard refreshed', 'info');
        }

        function formatDuration(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            return `${hours}h ${minutes}m`;
        }

        function checkSessionTimeout() {
            const lastActivity = localStorage.getItem('ops_dashboard_last_activity');
            if (lastActivity) {
                const inactiveTime = (Date.now() - parseInt(lastActivity)) / 1000;
                if (inactiveTime > CONFIG.SESSION_TIMEOUT) {
                    showToast('Session expired due to inactivity', 'warning');
                    logoutAgent();
                }
            }
            localStorage.setItem('ops_dashboard_last_activity', Date.now());
        }

        function autoSaveState() {
            if (state.updatesMade > 0 || state.summary) {
                saveState();
            }
        }

        function saveState() {
            const stateToSave = {
                data: state.globalData,
                summary: state.summary,
                updatesMade: state.updatesMade,
                sessionStart: state.sessionStart
            };
            
            localStorage.setItem('ops_dashboard_state', JSON.stringify(stateToSave));
        }

        function showSection(sectionId) {
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            // In a real app, this would show different sections
            showToast(`Navigating to ${sectionId} section`, 'info');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        // ================= ENHANCED UI COMPONENTS =================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'check-circle',
                warning: 'exclamation-triangle',
                danger: 'times-circle',
                info: 'info-circle'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas fa-${icons[type] || 'info-circle'}"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 2px;">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div style="font-size: 0.9rem; color: var(--text-gray);">${message}</div>
                </div>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: var(--text-gray); cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideOutRight 0.3s ease forwards';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Initialize
        initSession();
    </script>
</body>
</html>
